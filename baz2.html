<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css?family=Teko|Roboto+Condensed|Roboto" rel="stylesheet">

    <!-- <link href="https://fonts.googleapis.com/css2?display=swap&family=Roboto+Condensed|Roboto" rel="stylesheet"> -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://unpkg.com/vue"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.0.1/d3.min.js"
        integrity="sha512-1e0JvdNhUkvFbAURPPlFKcX0mWu/b6GT9e0uve7BW4MFxJ15q4ZCd/Llz+B7/oh+qhw7/l6Q1ObPt6aAuR01+Q=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.socket.io/3.1.3/socket.io.min.js"
        integrity="sha384-cPwlPLvBTa3sKAgddT6krw0cJat7egBga3DJepJyrLl4Q9/5WLra3rrnMcyTyOnh"
        crossorigin="anonymous"></script>


    <title>Document</title>
    <style>
        text {
            pointer-events: none;
        }

        body {
            background-color: #999;
        }

        .material-field {
            /* margin: 1em; */
            position: relative;
        }

        /* .6_17 { 
	overflow:hidden;
} */
        .button,
        select,
        input {
            font-size: 18px;
            padding: 13px 15px;
            margin-bottom: 20px;
            width: calc("100% - 30px");
            display: block;
            border-radius: 5px;
            border: 2px solid gray;
        }

        input:focus {
            outline: none;
            border: 2px solid dodgerblue;
        }

        input:focus.material-field-label {
            color: dodgerblue;
            transform: scale(.75) translate(-13px, -30px);
        }

        .input_filled~.material-field-label,
        select:focus~.material-field-label,
        input:focus~.material-field-label {
            color: dodgerblue;
            transform: scale(.75) translate(-13px, -30px);
        }

        label {
            color: #ccc;
            background: #fff;
            font-size: 16px;
            font-weight: normal;
            position: absolute;
            pointer-events: none;
            top: 15px;
            left: 8px;
            padding: 0 8px;
            transition: 150ms cubic-bezier(0.4, 0, 0.2, 1) all;
            -moz-transition: 150ms cubic-bezier(0.4, 0, 0.2, 1) all;
            -webkit-transition: 150ms cubic-bezier(0.4, 0, 0.2, 1) all;
        }

        .e6_17 {
            width: 180px;
            height: 84.9056625366211px;
            position: relative;
            margin: .38em;
        }

        .e1_2 {
            box-shadow: 0px 0.4245283007621765px 1.698113203048706px rgba(0, 0, 0, 0.25);
            /* background-color: rgba(255, 255, 255, 1); */
            background-color: #fefefe;
            width: 180px;
            height: 84.9056625366211px;
            /* position:absolute; */
            left: 0px;
            top: 0px;
            border-radius: 3.8207547664642334px;
        }

        .e1_2_1 {
            box-shadow: 0px 0.4245283007621765px 1.698113203048706px rgba(0, 0, 0, 0.25);
            background-color: rgba(255, 255, 255, 1);
            /* width: 180px; */
            /* height: 84.9056625366211px; */
            /* position:absolute; */
            /* left: 0px; */
            /* top: 0px; */
            /* display: inline-flex; */
            padding: 1em;
            border-radius: 3.8207547664642334px;
        }

        .ticker_name {
            color: black;
            width: 78.96226501464844px;
            height: 10.188679695129395px;
            position: absolute;
            left: 9px;
            top: 67.5px;
            font-family: Roboto;
            text-align: left;
            font-size: 10.188679695129395px;
            letter-spacing: 0;
        }

        .e6_18 {
            color: rgba(187.00000405311584, 187.00000405311584, 187.00000405311584, 1);
            width: 78.96226501464844px;

            height: 10.188679695129395px;
            position: absolute;
            right: 9px;
            top: 67.5px;
            font-family: Roboto;
            text-align: right;
            font-size: 10.188679695129395px;
            letter-spacing: 0;
        }

        .ticker {
            opacity: 0.62;
            color: rgba(119.00000050663948, 119.00000050663948, 119.00000050663948, 1);
            width: 158.34906005859375px;
            height: 37.97288513183594px;
            position: absolute;
            font-weight: 600;
            left: 6.79248046875px;
            top: 25.59967041015625px;
            font-family: 'Roboto Condensed';
            text-align: left;
            font-size: 40.75471878051758px;
            letter-spacing: 0;
        }

        .e6_7 {
            font-weight: 900;

            color: rgba(0, 0, 0, 1);
            width: 96.36792755126953px;
            height: 23.03972816467285px;
            position: absolute;
            left: 6.79248046875px;
            top: 6.8265380859375px;
            font-family: 'Roboto Condensed';
            text-align: left;
            font-size: 20.37735939025879px;
            letter-spacing: 0;

        }

        .percent_change {
            color: #222;
            width: 56.88679885864258px;
            height: 20.47975730895996px;
            position: absolute;
            left: 103.160400390625px;
            top: 11px;
            font-family: 'Roboto Condensed';
            text-align: left;
            font-size: 15.283019065856934px;
            letter-spacing: 0;
            font-weight: 900;

        }

        .time_scale_option_9 {
            color: #BBB;
            /* width: 13.160377502441406px; */
            height: 6px;
            position: absolute;
            left: 108px;
            font-family: 'Roboto';
            text-align: center;
            /* font-size: 5.94339656829834px; */
            letter-spacing: 0;
            font-weight: 900;
            display: flex;
            align-items: center;
            text-rendering: optimizeLegibility;
        }

        .time_scale_option_9>span {
            padding: 0 1.5px;
            opacity: .8;
            user-select: none;
        }

        .time_scale_option_9>span:hover {
            opacity: 1;
            color: dodgerblue;
            font-weight: 900;
            cursor: pointer;
        }

        [class^='time_scale_option_'] {


            font-size: 8px;
            top: 4px;
            font-family: 'Roboto';
        }

        /* https://www.w3schools.com/css/css_tooltip.asp */
        .tooltip {
            position: relative;
            display: inline-block;
            border-bottom: 1px dotted black;
            /* If you want dots under the hoverable text */
        }

        /* Tooltip text */
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 120px;
            background-color: black;
            color: #BBB;
            text-align: center;
            padding: 5px 0;
            border-radius: 6px;

            /* Position the tooltip text - see examples below! */
            position: absolute;
            z-index: 1;
        }

        /* Show the tooltip text when you mouse over the tooltip container */
        .tooltip:hover .tooltiptext {
            visibility: visible;
        }

        input {
            border: 0;
        }

        input:focus {
            outline: none;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dexie/3.2.0-rc.2/dexie.min.js"
        integrity="sha512-hJ1eR4h0vQbaojZAlCt5mDHE255IeqdRpK4IyBnXvAYDyBYfxMu2V2CA8PLAh8DdLB6x9ei9GRs+v2dUIGIjDQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/dexie-observable@3.0.0-beta.11/dist/dexie-observable.min.js"></script>

</head>

<body>
    <div id="app">
        <!-- https://codepen.io/nikhil8krishnan/pen/rVoXJa -->

        <div v-if="watch" style="display: inline-flex; flex-direction: column;">
            <!-- BEGIN COMPONENT -->


            <div draggable="true" @dragstart="drag(c)" class=e6_17 v-for="c in cryptocompare_prices">

                <svg style="position:absolute" viewBox="0 0 180 84.905662536621" xmlns="http://www.w3.org/2000/svg">


                    <template
                        v-if="historical[minutely_data_source]&&historical[minutely_data_source][c[0]]&&historical[minutely_data_source][c[0]].minutely">

                        <template v-for="s in [{data: historical[minutely_data_source][c[0]].minutely,x:d3.scaleTime().domain(d3.extent(historical[minutely_data_source][c[0]][chart_freq].map(e=>new Date(e.time)))).range([0,180]).nice(), 
                        y: d3.scaleLinear().domain([Math.min(...historical[minutely_data_source][c[0]][chart_freq].map(e=>e.low)), Math.max(...historical[minutely_data_source][c[0]][chart_freq].map(e=>e.high))]).range([84,0]).nice() 
                    }]">
                            <rect style="shape-rendering:crispEdges"
                                :fill="s.y(d.open)<s.y(d.close)?'#61FE61':'#FF6464'" v-for="d in s.data"
                                :x="(Math.round((s.x(d.time) + Number.EPSILON) * 100) / 100)-.125" :y="s.y(d.high)"
                                width=".25"
                                :height="(Math.round(((s.y(d.low)-s.y(d.high)) + Number.EPSILON) * 100) / 100)" />
                            <rect style="shape-rendering:crispEdges"
                                :fill="s.y(d.open)<s.y(d.close)?'#61FE61':'#FF6464'" v-for="d in s.data"
                                :x="(Math.round((s.x(d.time) + Number.EPSILON) * 100) / 100)-.5"
                                :y="Math.max(s.y(d.open),s.y(d.close))" width="1"
                                :height="(Math.round((Math.abs(s.y(d.open)-s.y(d.close)) + Number.EPSILON) * 100) / 100)" />
                        </template>
                    </template>
                </svg>




                <div @click="console.log(c)" class="e1_2"></div><span
                    class="ticker_name">{{coin_info_df.row(c[0],'symbol')[0].name_coinmarketcap}}</span><span
                    class="e6_18">$125.00 +25%</span><span class="ticker">{{c[0]}}</span><span
                    class="e6_7">${{c[1].USD.PRICE}}</span>
                <div class="time_scale_option_9"><span
                        :style="tf==='24HR'?'opacity: 1; color:dodgerblue;font-weight:900;':''"
                        v-for="tf in ['24HR','DAY','HOUR']">{{tf}}</span></div>
                <!-- https://iconmonstr.com/arrow-12-svg/ -->
                <span v-if="c[1].USD.CHANGEPCT24HOUR" class="percent_change"><svg
                        :style="`${Math.round((c[1].USD.CHANGEPCT24HOUR + Number.EPSILON) * 100) / 100 > 0 ? 'transform: rotate(270deg);fill: #61FE61':'transform: rotate(90deg);fill: #FF6464'}`"
                        xmlns="http://www.w3.org/2000/svg" width="9" height="9" viewBox="0 0 24 24">
                        <path d="M24 12l-12-9v5h-12v8h12v5l12-9z" />
                    </svg>{{Math.abs(Math.round((c[1].USD.CHANGEPCT24HOUR + Number.EPSILON) * 100) / 100)}}%</span>


            </div>

            <!-- END COMPONENT -->

        </div>

        <div style="display: inline-flex; flex-direction: column; justify-items: center;">

            <div class="e1_2_1">
                <svg @click="watch=!watch" xmlns="http://www.w3.org/2000/svg" width="48" height="48"
                    viewBox="0 0 24 24">
                    <path
                        d="M15 12c0 1.657-1.343 3-3 3s-3-1.343-3-3c0-.199.02-.393.057-.581 1.474.541 2.927-.882 2.405-2.371.174-.03.354-.048.538-.048 1.657 0 3 1.344 3 3zm-2.985-7c-7.569 0-12.015 6.551-12.015 6.551s4.835 7.449 12.015 7.449c7.733 0 11.985-7.449 11.985-7.449s-4.291-6.551-11.985-6.551zm-.015 12c-2.761 0-5-2.238-5-5 0-2.761 2.239-5 5-5 2.762 0 5 2.239 5 5 0 2.762-2.238 5-5 5z" />
                </svg>
                <svg @click="settings=!settings" xmlns="http://www.w3.org/2000/svg" width="48" height="48"
                    viewBox="0 0 24 24">
                    <path
                        d="M24 13.616v-3.232l-2.869-1.02c-.198-.687-.472-1.342-.811-1.955l1.308-2.751-2.285-2.285-2.751 1.307c-.613-.339-1.269-.613-1.955-.811l-1.021-2.869h-3.232l-1.021 2.869c-.686.198-1.342.471-1.955.811l-2.751-1.308-2.285 2.285 1.308 2.752c-.339.613-.614 1.268-.811 1.955l-2.869 1.02v3.232l2.869 1.02c.197.687.472 1.342.811 1.955l-1.308 2.751 2.285 2.286 2.751-1.308c.613.339 1.269.613 1.955.811l1.021 2.869h3.232l1.021-2.869c.687-.198 1.342-.472 1.955-.811l2.751 1.308 2.285-2.286-1.308-2.751c.339-.613.613-1.268.811-1.955l2.869-1.02zm-12 2.384c-2.209 0-4-1.791-4-4s1.791-4 4-4 4 1.791 4 4-1.791 4-4 4z" />
                </svg>

                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                    <path
                        d="M5.633 22.031c1.135 1.313 3.735 1.969 6.334 1.969 2.601 0 5.199-.656 6.335-1.969.081-.404 3.698-18.468 3.698-18.882 0-2.473-7.338-3.149-10-3.149-4.992 0-10 1.242-10 3.144 0 .406 3.556 18.488 3.633 18.887zm6.418-16.884c-4.211 0-7.625-.746-7.625-1.667s3.414-1.667 7.625-1.667 7.624.746 7.624 1.667-3.413 1.667-7.624 1.667z" />
                </svg>
                <svg width="24" height="24" xmlns="http://www.w3.org/2000/svg" fill-rule="evenodd" clip-rule="evenodd">
                    <path
                        d="M18 18h-12c-3.311 0-6-2.689-6-6s2.689-6 6-6h12.039c3.293.021 5.961 2.701 5.961 6 0 3.311-2.688 6-6 6zm-12-10c2.208 0 4 1.792 4 4s-1.792 4-4 4-4-1.792-4-4 1.792-4 4-4z" />
                </svg>
                <svg width="24" height="24" xmlns="http://www.w3.org/2000/svg" fill-rule="evenodd" clip-rule="evenodd">
                    <path
                        d="M6 18h12c3.311 0 6-2.689 6-6s-2.689-6-6-6h-12.039c-3.293.021-5.961 2.701-5.961 6 0 3.311 2.688 6 6 6zm12-10c-2.208 0-4 1.792-4 4s1.792 4 4 4 4-1.792 4-4-1.792-4-4-4z" />
                </svg>
            </div>
            <div style="min-width: 480px;" class="e1_2_1" ondrop="drop(event)" ondragover="allowDrop(event)">
                <div style="display:flex; align-items: center;">
                    <svg fill="dodgerblue" xmlns="http://www.w3.org/2000/svg" width="24" height="24"
                        viewBox="0 0 24 24">
                        <path d="M5 19h-4v-4h4v4zm6 0h-4v-8h4v8zm6 0h-4v-13h4v13zm6 0h-4v-19h4v19zm1 2h-24v2h24v-2z" />
                    </svg>


                    <div style="font-size: .62em; font-family: Roboto" v-if="chart_data"><span
                            style="font-size: 1.62rem!important; padding:0 .62em;  font-weight:900">{{coin_info_df.row(chart_data[0],'symbol')[0].name_coinmarketcap}}</span>
                        <span style="color:#BBB">
                            <!-- LAST HR -->
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                                <path
                                    d="M11 6v8h7v-2h-5v-6h-2zm-8.4 9.397l-1.799.906c-.302-.784-.521-1.607-.652-2.46l1.998-.159c.1.59.253 1.162.453 1.713zm4.393 7.501l.669-1.899c-.549-.265-1.068-.577-1.555-.933l-1.413 1.443c.708.545 1.478 1.012 2.299 1.389zm-5.319-4.795c.44.741.956 1.43 1.539 2.058l1.404-1.433c-.431-.471-.814-.982-1.149-1.528l-1.794.903zm10.322-18.103c-2.79 0-5.349.964-7.385 2.562l-2.183-2.183-1.356 7.013 7.015-1.354-2.05-2.049c1.666-1.245 3.724-1.989 5.959-1.989 5.516 0 10.003 4.486 10.003 10s-4.487 10-10.003 10c-.848 0-1.668-.118-2.455-.317l-.665 1.894c.996.267 2.039.423 3.12.423 6.629 0 12.004-5.373 12.004-12s-5.375-12-12.004-12zm-11.996 11.849l2.015-.161c.027-.703.125-1.386.288-2.047h-2.076c-.142.714-.217 1.453-.227 2.208z" />
                            </svg>
                            <!-- <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24">
                                <path
                                    d="M22 14c0 5.523-4.478 10-10 10s-10-4.477-10-10 4.478-10 10-10 10 4.477 10 10zm-2 0c0-4.411-3.589-8-8-8s-8 3.589-8 8 3.589 8 8 8 8-3.589 8-8zm-6-11.819v-2.181h-4v2.181c1.408-.238 2.562-.243 4 0zm6.679 3.554l1.321-1.321-1.414-1.414-1.407 1.407c.536.402 1.038.844 1.5 1.328zm-8.679 2.265v6h6c0-3.309-2.691-6-6-6z" />
                                </svg> -->
                            <!-- <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24"><path d="M15.91 13.34l2.636-4.026-.454-.406-3.673 3.099c-.675-.138-1.402.068-1.894.618-.736.823-.665 2.088.159 2.824.824.736 2.088.665 2.824-.159.492-.55.615-1.295.402-1.95zm-3.91-10.646v-2.694h4v2.694c-1.439-.243-2.592-.238-4 0zm8.851 2.064l1.407-1.407 1.414 1.414-1.321 1.321c-.462-.484-.964-.927-1.5-1.328zm-18.851 4.242h8v2h-8v-2zm-2 4h8v2h-8v-2zm3 4h7v2h-7v-2zm21-3c0 5.523-4.477 10-10 10-2.79 0-5.3-1.155-7.111-3h3.28c1.138.631 2.439 1 3.831 1 4.411 0 8-3.589 8-8s-3.589-8-8-8c-1.392 0-2.693.369-3.831 1h-3.28c1.811-1.845 4.321-3 7.111-3 5.523 0 10 4.477 10 10z"/></svg> -->
                        </span>{{(Math.round((chart_data[1].USD.CHANGEPCTHOUR + Number.EPSILON) * 100) / 100)}}%
                        <span style="color:#BBB">
                            <!-- LAST 24 HRS -->
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                                <path
                                    d="M21.854 13.683l1.998.159c-.132.854-.351 1.676-.652 2.46l-1.8-.905c.2-.551.353-1.123.454-1.714zm-2.548 7.826l-1.413-1.443c-.486.356-1.006.668-1.555.933l.669 1.899c.821-.377 1.591-.844 2.299-1.389zm1.226-4.309c-.335.546-.719 1.057-1.149 1.528l1.404 1.433c.583-.627 1.099-1.316 1.539-2.058l-1.794-.903zm-20.532-5.2c0 6.627 5.375 12 12.004 12 1.081 0 2.124-.156 3.12-.424l-.665-1.894c-.787.2-1.607.318-2.455.318-5.516 0-10.003-4.486-10.003-10s4.487-10 10.003-10c2.235 0 4.293.744 5.959 1.989l-2.05 2.049 7.015 1.354-1.355-7.013-2.184 2.183c-2.036-1.598-4.595-2.562-7.385-2.562-6.629 0-12.004 5.373-12.004 12zm23.773-2.359h-2.076c.163.661.261 1.344.288 2.047l2.015.161c-.01-.755-.085-1.494-.227-2.208zm-9.005 5.359v-1.419h-2.594v-1.295l2.722-3.653h1.288v3.689h.816v1.259h-.815v1.419h-1.417zm0-2.679v-1.695l-1.263 1.695h1.263zm-7.768 2.679c0-.961.275-1.709 1.234-2.419 1.129-.836 1.99-1.165 1.99-1.939 0-.512-.308-.83-.804-.83-.69 0-.855.723-.855 1.411h-1.421c-.06-1.782.951-2.713 2.338-2.713 1.287 0 2.22.856 2.22 2.036 0 .589-.183 1.056-.576 1.469-.621.655-1.552.985-2.163 1.682h2.774v1.303h-4.737z" />
                            </svg>
                        </span>{{(Math.round((chart_data[1].USD.CHANGEPCT24HOUR + Number.EPSILON) * 100) / 100)}}%
                        <span style="color:#BBB">
                            <!-- TODAY -->
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                                <path
                                    d="M22.088 13.126l1.912-1.126-1.912-1.126c-1.021-.602-1.372-1.91-.788-2.942l1.093-1.932-2.22-.02c-1.185-.01-2.143-.968-2.153-2.153l-.02-2.219-1.932 1.093c-1.031.583-2.34.233-2.941-.788l-1.127-1.913-1.127 1.913c-.602 1.021-1.91 1.372-2.941.788l-1.932-1.093-.02 2.219c-.01 1.185-.968 2.143-2.153 2.153l-2.22.02 1.093 1.932c.584 1.032.233 2.34-.788 2.942l-1.912 1.126 1.912 1.126c1.021.602 1.372 1.91.788 2.942l-1.093 1.932 2.22.02c1.185.01 2.143.968 2.153 2.153l.02 2.219 1.932-1.093c1.031-.583 2.34-.233 2.941.788l1.127 1.913 1.127-1.913c.602-1.021 1.91-1.372 2.941-.788l1.932 1.093.02-2.219c.011-1.185.969-2.143 2.153-2.153l2.22-.02-1.093-1.932c-.584-1.031-.234-2.34.788-2.942zm-10.117 6.874c-4.411 0-8-3.589-8-8s3.588-8 8-8 8 3.589 8 8-3.589 8-8 8zm.029-2c-3.313 0-6-2.687-6-6s2.687-6 6-6v12z" />
                            </svg>
                        </span>{{(Math.round((chart_data[1].USD.CHANGEPCTDAY + Number.EPSILON) * 100) / 100)}}%</div>
                    <div v-else>Drop data here.</div>

                </div>
                <div style="position: relative; width:100%"
                    v-if="chart_data&&historical[minutely_data_source]&&historical[minutely_data_source][chart_data[0]]&&historical[minutely_data_source][chart_data[0]]">

                    <div style="left:0;" class="time_scale_option_9"><span
                            :style="freq===tf.slice(0,3)?'opacity: 1; color:dodgerblue;font-weight:900;':''"
                            v-for="tf in ['MINUTE','HOUR','DAY','MONTH']">{{tf.slice(0,3)}}</span></div>

                    <!-- BEGIN COMPONENT 2-->




                    <template v-for="s in [{data: historical[minutely_data_source][chart_data[0]][chart_freq].slice(-100),x:d3.scaleTime().domain(d3.extent(historical[minutely_data_source][chart_data[0]][chart_freq].slice(-100).map(e=>new Date(e.time*1000)))).range([0,100-7.5]).nice(), 
                                y: d3.scaleLinear().domain([Math.min(...historical[minutely_data_source][chart_data[0]][chart_freq].map(e=>e.low)), Math.max(...historical[minutely_data_source][chart_data[0]][chart_freq].map(e=>e.high))]).range([62-5,0+5]).nice() 
                            }]">
                        <!-- {{s.data.slice(9).length}}
                            {{exponentialMovingAverage(s.data.map(d=>d.close),10).length}}
                         -->
                        <div style="font-size: .5em; font-family: Roboto" v-if="chart_data"><span
                                style="padding:0 .62em; width: 300px; position: absolute;right:0; font-weight:900"><span
                                    style="color:#BBB">FROM:
                                </span>
                                {{s.x.domain()[0]}}<br><span style="color:#BBB">TO:
                                </span> {{s.x.domain()[1]}}</div>

                        <!-- historical[minutely_data_source][chart_data[0]].minutely -->
                        <svg xmlns="http://www.w3.org/2000/svg" width="100%" viewBox="0 0 100 62">
                            <!-- https://stackoverflow.com/questions/35434315/how-to-get-crispedges-for-svg-text -->
                            <defs>
                                <filter id="crispify">
                                    <feComponentTransfer>
                                        <feFuncA type="discrete" tableValues="0 1" />
                                    </feComponentTransfer>
                                </filter>
                            </defs>

                            <line stroke="whitesmoke" stroke-width=".25%" v-for="t in s.x.ticks().slice(1).slice(0,-1)"
                                :x1="s.x(t)" :x2="s.x(t)" y1="0" :y2="84.905662536621" />
                            <path v-if="sma" :style="`fill:none; stroke-width: .1px; stroke: ${sma_color}`"
                                :d='d3.line() .curve(d3.curveCardinal).x(d =>s.x(d[0])).y(d=>s.y(d[1]))(chart_data_sma.filter(e=>e[0]>=s.x.domain()[0]&&e[0]<=s.x.domain()[1]))'>
                            </path>
                            <path v-if="ema" :style="`fill:none; stroke-width: .1px; stroke: ${ema_color}`"
                                :d='d3.line() .curve(d3.curveCardinal).x(d =>s.x(d[0])).y(d=>s.y(d[1]))(chart_data_ema.filter(e=>e[0]>=s.x.domain()[0]&&e[0]<=s.x.domain()[1]))'>
                            </path>
                            <!-- <path v-if="ema" :style="`fill:none; stroke-width: .1px; stroke: purple`"
                                :d='d3.line()
                .curve(d3.curveCardinal)
                .x(d => s.x(new Date(d[0])))
                .y(d => s.y(d[1]))(d3.zip(s.data.slice(ema_window-1).map(d=>d.time*1000), exponentialMovingAverage(s.data.map(d=>d.close),ema_window)))'>
                            </path> -->

                            <line stroke="#EEE" stroke-width=".125px" v-for="t in s.x.ticks()"
                                :x1="s.x(new Date(t*1000))" :x2="s.x(new Date(t*1000))" y1="0" :y2="62" />
                            <line stroke="dodgerblue" stroke-width=".125px" stroke-dasharray="1" :x1="0" :x2="100"
                                :y1="s.y(todaysprices[chart_data[0]].USD.PRICE)"
                                :y2="s.y(todaysprices[chart_data[0]].USD.PRICE)" />

                            <rect x="92.5px" :y="s.y(todaysprices[chart_data[0]].USD.PRICE)-1.5" width="9" height="3px"
                                fill="dodgerblue" />
                            <text x="96.25px" height="3px" width="8"
                                style="font-weight: 900; fill: white; font-size: 1.75px; font-family: 'Roboto Condensed'"
                                :y="s.y(todaysprices[chart_data[0]].USD.PRICE)+.15" dominant-baseline="middle"
                                text-anchor="middle">{{todaysprices[chart_data[0]].USD.PRICE}}</text>
                            <rect x="92.5px" :y="s.y(s.y.domain()[0])-1.5" width="9" height="3px" fill="gray" />
                            <text x="96.25px" height="3px" width="8"
                                style="font-weight: 900; fill: white; font-size: 1.75px; font-family: 'Roboto Condensed'"
                                :y="s.y(s.y.domain()[0])+.15" dominant-baseline="middle"
                                text-anchor="middle">{{s.y.domain()[0]}}</text>
                            <rect x="92.5px" :y="s.y(s.y.domain()[1])-1.5" width="9" height="3px" fill="gray" />
                            <text x="96.25px" height="3px" width="8"
                                style="font-weight: 900; fill: white; font-size: 1.75px; font-family: 'Roboto Condensed'"
                                :y="s.y(s.y.domain()[1])+.15" dominant-baseline="middle"
                                text-anchor="middle">{{s.y.domain()[1]}}</text>

                            <!-- <text :y="s.y(todaysprices[chart_data[0]].USD.PRICE)">{{todaysprices[chart_data[0]].USD.PRICE}}</text> -->
                            <rect style="shape-rendering:crispEdges"
                                :fill="s.y(d.open)<s.y(d.close)?'#61FE61':'#FF6464'" v-for="d in s.data"
                                :x="(Math.round((s.x(d.time*1000) + Number.EPSILON) * 100) / 100)-.05" :y="s.y(d.high)"
                                width=".1px"
                                :height="(Math.round(((s.y(d.low)-s.y(d.high)) + Number.EPSILON) * 100) / 100)" />
                            <rect style="shape-rendering:crispEdges"
                                :fill="s.y(d.open)<s.y(d.close)?'#61FE61':'#FF6464'" v-for="d in s.data"
                                :x="`${(Math.round((s.x(d.time*1000) + Number.EPSILON) * 100) / 100)-.25}px`"
                                :y="Math.max(s.y(d.open),s.y(d.close))" width=".5px"
                                :height="(Math.round((Math.abs(s.y(d.open)-s.y(d.close)) + Number.EPSILON) * 100) / 100)" />
                            <text style="text-anchor: middle;font-family: Roboto; font-size:2px; font-weight: 900"
                                v-for="t in s.x.ticks().slice(1).slice(0, -1)" :x="s.x(t)" y="60">
                                {{t.getHours()}}:{{t.getMinutes()}}</text>
                    </template>



                    <!-- <text style="dominant-baseline: central" v-for="t in candles_y.ticks()" :x="width+30" :y=candles_y(t)
                    class="small">{{t}}</text> -->


                    </svg>
                    <!-- END COMPONENT 2-->
                    <!-- <div>EMA <input v-model="ema_window" type="text" name="" id="">
                        <span @click="ema=!ema"><input style="pointer-events:none;" v-model="ema" type="checkbox"
                                name="" id=""></span>
                    </div> -->

                </div>

                <div v-if="chart_data" style="display: flex; align-items: center;">


                    <span style="display:inline-block; width: 24px">
                        <input v-model="sma_color" type="color" style='opacity:0;width:24px;position:absolute;' />
                        <svg :style="`fill:${sma?sma_color:'lightgray'}`" xmlns="http://www.w3.org/2000/svg" width="24"
                            height="24" viewBox="0 0 24 24">
                            <path
                                d="M17.839 7.67c1.095-1.098 2.874-1.871 3.685-3.113.887-1.365.502-3.188-.863-4.082-1.363-.885-3.188-.499-4.086.865-.838 1.288-.791 3.324-1.424 4.781-.812 1.883-3.552 2.123-6.706.488-1.722 3.356-4.065 6.957-6.445 9.884l11.548 7.507c1.496-2.886 4.407-7.348 6.441-9.883-2.827-2.263-3.675-4.925-2.15-6.447zm1.752-5.545c.452.294.582.906.282 1.357-.294.461-.905.584-1.356.29-.458-.299-.585-.903-.287-1.356.292-.458.903-.589 1.361-.291zm-6.664 19.227l-8.25-5.362c.976-1.265 1.753-2.481 2.812-4.104.427-.656.933-.793 1.234-.598 1.104.717-1.507 3.625-.329 4.391 1.169.759 2.889-3.368 4.161-2.539.985.64-.79 2.698.209 3.346.465.303 1.133-.258 1.716-.631 1.006-.645 1.939.006.956 1.516-.981 1.501-1.516 2.315-2.509 3.981z" />
                        </svg>
                        <!-- <button>clickme</button> -->
                    </span>

                    <span @click="sma=!sma" style="display:inline-block; width: 24px">
                        <svg :style="`${sma?'':'fill:lightgray'}`" xmlns="http://www.w3.org/2000/svg" width="24"
                            height="24" viewBox="0 0 24 24">
                            <path
                                d="M15 12c0 1.657-1.343 3-3 3s-3-1.343-3-3c0-.199.02-.393.057-.581 1.474.541 2.927-.882 2.405-2.371.174-.03.354-.048.538-.048 1.657 0 3 1.344 3 3zm-2.985-7c-7.569 0-12.015 6.551-12.015 6.551s4.835 7.449 12.015 7.449c7.733 0 11.985-7.449 11.985-7.449s-4.291-6.551-11.985-6.551zm-.015 12c-2.761 0-5-2.238-5-5 0-2.761 2.239-5 5-5 2.762 0 5 2.239 5 5 0 2.762-2.238 5-5 5z" />
                        </svg>
                    </span>

                    <span style="display:inline-block; padding: 0 5px; width: 24px; padding: 2px;">
                        <input :disabled="!ema" v-model="sma_window"
                            :style="`border: 2px solid ${sma?'#444':'lightgray'}; font-weight:900; font-size:.8em; font-family: 'Roboto Condensed'; padding: 1px; margin: 0; height: 20px; width:28px`"
                            type="text">
                    </span>

                    <span style="display:inline-block; padding: 2px;">
                        <span
                            :style="`${sma?'':'color:lightgray;'}user-select: none; font-size: .8em; font-weight:600; font-family: 'Roboto';`">&nbsp;&nbsp;&nbsp;Simple
                            Moving Average</span>
                    </span>
                </div>
                <div v-if="chart_data" style="display: flex; align-items: center;">


                    <span style="display:inline-block; width: 24px">
                        <input v-model="ema_color" type="color" style='opacity:0;width:24px;position:absolute;' />
                        <svg :style="`fill:${ema?ema_color:'lightgray'}`" xmlns="http://www.w3.org/2000/svg" width="24"
                            height="24" viewBox="0 0 24 24">
                            <path
                                d="M17.839 7.67c1.095-1.098 2.874-1.871 3.685-3.113.887-1.365.502-3.188-.863-4.082-1.363-.885-3.188-.499-4.086.865-.838 1.288-.791 3.324-1.424 4.781-.812 1.883-3.552 2.123-6.706.488-1.722 3.356-4.065 6.957-6.445 9.884l11.548 7.507c1.496-2.886 4.407-7.348 6.441-9.883-2.827-2.263-3.675-4.925-2.15-6.447zm1.752-5.545c.452.294.582.906.282 1.357-.294.461-.905.584-1.356.29-.458-.299-.585-.903-.287-1.356.292-.458.903-.589 1.361-.291zm-6.664 19.227l-8.25-5.362c.976-1.265 1.753-2.481 2.812-4.104.427-.656.933-.793 1.234-.598 1.104.717-1.507 3.625-.329 4.391 1.169.759 2.889-3.368 4.161-2.539.985.64-.79 2.698.209 3.346.465.303 1.133-.258 1.716-.631 1.006-.645 1.939.006.956 1.516-.981 1.501-1.516 2.315-2.509 3.981z" />
                        </svg>
                        <!-- <button>clickme</button> -->
                    </span>

                    <span @click="ema=!ema" style="display:inline-block; width: 24px">
                        <svg :style="`${ema?'':'fill:lightgray'}`" xmlns="http://www.w3.org/2000/svg" width="24"
                            height="24" viewBox="0 0 24 24">
                            <path
                                d="M15 12c0 1.657-1.343 3-3 3s-3-1.343-3-3c0-.199.02-.393.057-.581 1.474.541 2.927-.882 2.405-2.371.174-.03.354-.048.538-.048 1.657 0 3 1.344 3 3zm-2.985-7c-7.569 0-12.015 6.551-12.015 6.551s4.835 7.449 12.015 7.449c7.733 0 11.985-7.449 11.985-7.449s-4.291-6.551-11.985-6.551zm-.015 12c-2.761 0-5-2.238-5-5 0-2.761 2.239-5 5-5 2.762 0 5 2.239 5 5 0 2.762-2.238 5-5 5z" />
                        </svg>
                    </span>

                    <span style="display:inline-block; padding: 0 5px; width: 24px; padding: 2px;">
                        <input :disabled="!ema" v-model="ema_window"
                            :style="`border: 2px solid ${ema?'#444':'lightgray'}; font-weight:900; font-size:.8em; font-family: 'Roboto Condensed'; padding: 1px; margin: 0; height: 20px; width:28px`"
                            type="text">
                    </span>

                    <span style="display:inline-block; padding: 2px;">
                        <span
                            :style="`${ema?'':'color:lightgray;'}user-select: none; font-size: .8em; font-weight:600;  font-family: 'Roboto';`">&nbsp;&nbsp;&nbsp;Exponential
                            Moving Average</span>
                    </span>
                </div>


            </div>
            <div v-if="settings" class="e1_2_1">


                <div>

                    <div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                            <path
                                d="M24 14.187v-4.374c-2.148-.766-2.726-.802-3.027-1.529-.303-.729.083-1.169 1.059-3.223l-3.093-3.093c-2.026.963-2.488 1.364-3.224 1.059-.727-.302-.768-.889-1.527-3.027h-4.375c-.764 2.144-.8 2.725-1.529 3.027-.752.313-1.203-.1-3.223-1.059l-3.093 3.093c.977 2.055 1.362 2.493 1.059 3.224-.302.727-.881.764-3.027 1.528v4.375c2.139.76 2.725.8 3.027 1.528.304.734-.081 1.167-1.059 3.223l3.093 3.093c1.999-.95 2.47-1.373 3.223-1.059.728.302.764.88 1.529 3.027h4.374c.758-2.131.799-2.723 1.537-3.031.745-.308 1.186.099 3.215 1.062l3.093-3.093c-.975-2.05-1.362-2.492-1.059-3.223.3-.726.88-.763 3.027-1.528zm-4.875.764c-.577 1.394-.068 2.458.488 3.578l-1.084 1.084c-1.093-.543-2.161-1.076-3.573-.49-1.396.581-1.79 1.693-2.188 2.877h-1.534c-.398-1.185-.791-2.297-2.183-2.875-1.419-.588-2.507-.045-3.579.488l-1.083-1.084c.557-1.118 1.066-2.18.487-3.58-.579-1.391-1.691-1.784-2.876-2.182v-1.533c1.185-.398 2.297-.791 2.875-2.184.578-1.394.068-2.459-.488-3.579l1.084-1.084c1.082.538 2.162 1.077 3.58.488 1.392-.577 1.785-1.69 2.183-2.875h1.534c.398 1.185.792 2.297 2.184 2.875 1.419.588 2.506.045 3.579-.488l1.084 1.084c-.556 1.121-1.065 2.187-.488 3.58.577 1.391 1.689 1.784 2.875 2.183v1.534c-1.188.398-2.302.791-2.877 2.183zm-7.125-5.951c1.654 0 3 1.346 3 3s-1.346 3-3 3-3-1.346-3-3 1.346-3 3-3zm0-2c-2.762 0-5 2.238-5 5s2.238 5 5 5 5-2.238 5-5-2.238-5-5-5z" />
                        </svg><span style="font-size: 1.62em; font-weight: 900; font-family: 'Roboto Condensed';">
                            Settings</span>
                    </div>
                    <div>Current Price Data:
                        <span @click="console.log(c_price=!c_price)"><input style="pointer-events:none;"
                                v-model="c_price" type="checkbox" name="" id=""></span></div>
                    <div>Minute OHLC Data:
                        <span @click="console.log(minute_OHLC=!minute_OHLC)"><input style="pointer-events:none;"
                                v-model="minute_OHLC" type="checkbox" name="" id=""></span>
                    </div>
                    <div style="display:flex; align-items: center;">
                        <span style="user-select: none;height: 24px;line-height: 24px">
                            Hour OHLC Data:
                        </span>
                        <span style="display: inline-block; height: 24px" @click="console.log(HOU=!HOU)">
                            <svg style="padding: 0; margin: 0; pointer-events:none;" v-if="!HOU" width="24" height="24"
                                xmlns="http://www.w3.org/2000/svg" fill="lightgray" fill-rule="evenodd"
                                clip-rule="evenodd">
                                <path
                                    d="M18 18h-12c-3.311 0-6-2.689-6-6s2.689-6 6-6h12.039c3.293.021 5.961 2.701 5.961 6 0 3.311-2.688 6-6 6zm-12-10c2.208 0 4 1.792 4 4s-1.792 4-4 4-4-1.792-4-4 1.792-4 4-4z" />
                            </svg>
                            <svg style="padding: 0; margin: 0; pointer-events:none;" v-else width="24" height="24"
                                xmlns="http://www.w3.org/2000/svg" fill="dodgerblue" fill-rule="evenodd"
                                clip-rule="evenodd">
                                <path
                                    d="M6 18h12c3.311 0 6-2.689 6-6s-2.689-6-6-6h-12.039c-3.293.021-5.961 2.701-5.961 6 0 3.311 2.688 6 6 6zm12-10c-2.208 0-4 1.792-4 4s1.792 4 4 4 4-1.792 4-4-1.792-4-4-4z" />
                            </svg>
                        </span>
                        <span style="user-select: none;height: 24px;line-height: 24px; font-size: .62em">
                            Last udpated: {{new Date(HOU_last_update)}}
                        </span>
                    </div>
                    <div>

                        Current Price Data Source: <input v-model="minutely_data_source" type="text" disabled name=""
                            id="">
                    </div>
                    <div>
                        Minute Candle Data Source: <input v-model="minutely_data_source" type="text" disabled name=""
                            id="">
                    </div>
                </div>
                <svg style="width: 100%" viewBox="0 0 180 84.905662536621" xmlns="http://www.w3.org/2000/svg">
                    <text v-if="ticker_c">{{c[0]}}</text>
                </svg>
                <!--        <svg style="position:absolute" viewBox="0 0 180 84.905662536621" xmlns="http://www.w3.org/2000/svg">
                    
                    
                    <template v-if="cryptocompare_historical[c[0]]">
                        <text x=5 y=10>{{ c[0]}}</text>

                        <template v-for="s in [{data: cryptocompare_historical[c[0]].minutely.Data.Data,x:d3.scaleTime().domain(d3.extent(cryptocompare_historical[c[0]].minutely.Data.Data.map(e=>new Date(e.time)))).range([0,180]).nice(), 
                            y: d3.scaleLinear().domain([Math.min(...cryptocompare_historical[c[0]].minutely.Data.Data.map(e=>e.low)), Math.max(...cryptocompare_historical[c[0]].minutely.Data.Data.map(e=>e.high))]).range([84,0]).nice() 
                        }]">
                             <line stroke="whitesmoke" v-for="t in s.x.ticks()" :x1="s.x(new Date(t))"
                                :x2="s.x(new Date(t))" y1="0" :y2="84.905662536621" /> 
                            <line stroke="whitesmoke" v-for="t in s.y.ticks().slice(1, s.y.ticks().length-1).filter((e,i)=>i%2)" :x1="0" :x2="180"
                                :y1="s.y(t)" :y2="s.y(t)" />
                       


                            <rect style="shape-rendering:crispEdges"
                                :fill="s.y(d.open)<s.y(d.close)?'#61FE61':'#FF6464'" v-for="d in s.data"
                                :x="(Math.round((s.x(d.time) + Number.EPSILON) * 100) / 100)-.125" :y="s.y(d.high)"
                                width=".25"
                                :height="(Math.round(((s.y(d.low)-s.y(d.high)) + Number.EPSILON) * 100) / 100)" />
                            <rect style="shape-rendering:crispEdges"
                                :fill="s.y(d.open)<s.y(d.close)?'#61FE61':'#FF6464'" v-for="d in s.data"
                                :x="(Math.round((s.x(d.time) + Number.EPSILON) * 100) / 100)-.5"
                                :y="Math.max(s.y(d.open),s.y(d.close))" width="1"
                                :height="(Math.round((Math.abs(s.y(d.open)-s.y(d.close)) + Number.EPSILON) * 100) / 100)" />
                        </template>
                    </template>
                </svg> -->






            </div>
        </div>
    </div>
</body>

<script type="module" src="./d3fc/d3fc_ta.js"></script>
<script src="config.js"></script>
<script>
    const tickers = [], colors = ['orange', 'blue', 'indigo', 'violet', 'cyan', 'magenta', 'yellow', 'black']
    const app = new Vue({
        methods: {
            async get_minutely_from_cryptocompare() {
                console.log(this.get_hourly_from_cryptocompare());

                if (!this.minute_OHLC) return console.log('Minutely data not in sync.');
                let s, now = Math.round(Date.now() / 1000), then = now - (3 * 60 * 60), ticker_i = this.tickers.length;
                (async function (app) {
                    let _datapoints = await cryptxgang_db.data.where('time').below(then).delete().then(count => {
                        if (count) console.log(`Deleted ${count} datapoints earlier than ${new Date(then * 1000)}`)
                    });
                    s = Date.now()
                    console.log('retrieving OHLVC minutely data from cryptocompare...');
                    while (app.tickers[--ticker_i]) {
                        if (!app.minute_OHLC) {
                            console.log('Minutely data not in sync.');
                            break;
                        }
                        console.log('querying ' + app.tickers[ticker_i] + ' OHLVC minutely data from cryptocompare...');
                        let l = (_datapoints = await cryptxgang_db.data.where('freq').equals(60).and(dp => dp.symbol === app.tickers[ticker_i]).and(dp => dp.time >= Math.round(Date.now() / 1000)).toArray()).length;

                        if (!l) {
                            console.log('retrieving ' + app.tickers[ticker_i] + ' OHLVC minutely data from cryptcompare...');
                            await get_cryptocompare_minutely(app.tickers[ticker_i]).then(async datapoints => {
                                datapoints.forEach(async (dp, i) => {
                                    let fred = await cryptxgang_db.data.where('[freq+symbol+time]').equals([60, app.tickers[ticker_i], dp.time]).count();
                                    // console.log(dp) 
                                    // console.log({ fred })
                                    if (fred) return;
                                    //     //     datapoints.map(g => ({ ...g, symbol, freq: 60, platform: 'cryptocompare' })).forEach(async (dp, i) => {
                                    //     //         // console.log({ fred })
                                    //     //         // console.log({ dp })
                                    let waldo = await cryptxgang_db.data.put({ ...dp, symbol: app.tickers[ticker_i], freq: 60, platform: 'cryptocompare' });
                                    console.log(`Minutely cryptocompare datapoint {time: ${dp.time}} added for ${app.tickers[ticker_i]}`);
                                });
                            })
                        };

                        // let quux = await cryptxgang_db.data.where('freq').equals(60).and(dp => dp.symbol === app.tickers[ticker_i]).toArray();
                        await wait(3000).then(async k => {
                            console.log(app.tickers[ticker_i] + ' waited ' + (Date.now() - s) + ' ms');
                        })
                    };
                    console.log('done retrieving OHLVC minutely data from cryptcompare...');

                })(app);
                this.tickers.forEach(async symbol => {

                    // let _datapoints = await cryptxgang_db.data.where('time').below(then).delete().then(count => {
                    //     if (count) console.log(`Deleted ${count} datapoints earlier than ${new Date(then * 1000)}`)
                    // })//await cryptxgang_db.data.where('time').below(then).toArray(), l = _datapoints.length;;

                    // console.log('querying ' + symbol + ' OHLVC minutely data from cryptocompare...');
                    // console.log('looking for ' + symbol + ' OHLVC minutely datapoints from cryptcompare...');

                    // console.log([60, symbol, Math.round(Date.now() / 1000)].join(''))
                    // let l = (_datapoints = await cryptxgang_db.data.where('[freq+symbol+time]').aboveOrEqual([60, symbol, Math.round(Date.now() / 1000)]).toArray()).length;
                    let l = (_datapoints = await cryptxgang_db.data.where('freq').equals(60).and(dp => dp.symbol === symbol).and(dp => dp.time >= Math.round(Date.now() / 1000)).toArray()).length;

                    // console.log({[symbol]:l})
                    // console.log({ _datapoints })


                    if (!l) {
                        // return;
                        // let xyzzy = await get_cryptocompare_minutely(symbol).then(async datapoints => new Promise(async (resolve, reject) => {

                        //     console.log('retrieving ' + symbol + ' OHLVC minutely data from cryptcompare...');
                        //     datapoints.map(g => ({ ...g, symbol, freq: 60, platform: 'cryptocompare' })).forEach(async (dp, i) => {
                        //         let fred = await cryptxgang_db.data.where('[freq+symbol+time]').equals([60, symbol, dp.time]).count();
                        //         // console.log({ fred })
                        //         if (fred) return;
                        //         // console.log({ dp })
                        //         let waldo = await cryptxgang_db.data.put(dp);
                        //         console.log(`Minutely cryptocompare datapoint {time: ${dp.time}} added for ${symbol}`);
                        //     });
                        //     let s = Date.now()
                        //     console.log('waiting...')
                        //     await wait(3000).then(k => {
                        //         console.log('waited ' + (Date.now() - s) + ' ms');
                        //         resolve(1);
                        //     });

                        // }));

                    };
                })
                this.MIN_last_update = s;
            },
            async get_hourly_from_cryptocompare() {
                if (!this.HOU) return console.log('Hourly data not in sync.');
                let d = new Date();
                // if(!(new Date(this.HOU_last_update) < new Date(d.getFullYear(),d.getMonth(),d.getDate(),d.getHours(),0,0))) return;
                let s, ticker_i = this.tickers.length;
                (async function (app) {
                    let now = Math.round(Date.now() / 1000), then = now - (300 * 60 * 60);
                    let _datapoints = await cryptxgang_db.data.where('time').below(then).and(dp => dp.freq === 360).delete().then(count => {
                        if (count) console.log(`Deleted ${count} datapoints earlier than ${new Date(then * 1000)}`)
                    });
                    s = Date.now()
                    // console.log('retrieving OHLVC hourly data from cryptocompare...');
                    // return;
                    while (app.tickers[--ticker_i]) {
                        if (!app.HOU) {
                            console.log('Hourly data not in sync.');
                            break;
                        }
                        if (!(new Date(app.HOU_last_update[app.tickers[ticker_i]] || (app.HOU_last_update[app.tickers[ticker_i]] = 0)) < new Date(d.getFullYear(), d.getMonth(), d.getDate(), d.getHours(), 0, 0))) continue //< new Date(d.getFullYear(), d.getMonth(), d.getDate(), d.getHours(), 0, 0))) return;

                        console.log('querying ' + app.tickers[ticker_i] + ' local OHLVC hourly data from cryptocompare...');
                        let f = new Date();
                        f.setHours(f.getHours(), 0, 0, 0)
                        let l = (_datapoints = await cryptxgang_db.data.where('freq').equals(360).and(dp => dp.symbol === app.tickers[ticker_i]).and(dp => dp.time >= Math.round(f.getTime() / 1000)).toArray()).length;
                        console.log({l})
                        if (!l) {
                            console.log('retrieving ' + app.tickers[ticker_i] + ' OHLVC hourly data from cryptcompare...');
                            await get_cryptocompare_hourly(app.tickers[ticker_i]).then(async datapoints => {
                                datapoints.forEach(async (dp, i) => {
                                    let fred = await cryptxgang_db.data.where('[freq+symbol+time]').equals([360, app.tickers[ticker_i], dp.time]).count();
                                    if (fred) return;
                                    let waldo = await cryptxgang_db.data.put({ ...dp, symbol: app.tickers[ticker_i], freq: 360, platform: 'cryptocompare' });
                                    console.log(`Hourly cryptocompare datapoint {time: ${dp.time}} added for ${app.tickers[ticker_i]}`);
                                });
                            });
                            app.HOU_last_update[app.tickers[ticker_i]] = s;
                        };



                        // let quux = await cryptxgang_db.data.where('freq').equals(360).and(dp => dp.symbol === app.tickers[ticker_i]).toArray();
                        await wait(3000).then(async k => {
                            console.log(app.tickers[ticker_i] + ' waited ' + (Date.now() - s) + ' ms');
                        })
                    };
                    // TODO: chec for each individual ticker's last update
                    // app.HOU_last_update = s;
                    console.log('done retrieving OHLVC hourly data from cryptcompare...');

                })(app);
                // this.tickers.forEach(async symbol => {
                //     // Promise.all(app.tickers.map(async e => await cryptxgang_db.data.where('symbol').equals(e).toArray())).then(e=>console.log(e))
                //     // console.log(app.datapoints = [].concat(...foobar));
                //     let l = (_datapoints = await cryptxgang_db.data.where('freq').equals(60).and(dp => dp.symbol === symbol).and(dp => dp.time >= Math.round(Date.now() / 1000)).toArray()).length;
                //     // let l = (_datapoints = await cryptxgang_db.data.where('freq').equals(60).and(dp => dp.symbol === symbol).and(dp => dp.time >= Math.round(Date.now() / 1000)).toArray()).length;


                //     if (!l) {
                //     };
                // })
            },

            async get_price_from_cryptocompare() {
                if (!this.c_price) return console.log('Price data not in sync.');
                let foo = await get_cryptocompare_prices(this.tickers);//.then(e => );
                if (foo.Response === 'Error') return alert(foo.Message);
                console.log('getting prices from cryptcompare...');
                this.cryptocompare_prices = Object.entries(foo.RAW);
            }
        },
        computed: {
            chart_data_sma() {
                if (!this.indicatorMovingAverage || !this.chart_data) return []
                if (this.historical && this.minutely_data_source && this.historical[this.minutely_data_source] && this.historical[this.minutely_data_source][this.chart_data[0]]) {
                    // console.log(this.chart_freq, this.historical[this.minutely_data_source][this.chart_data[0]])
                    return d3.zip(this.historical[this.minutely_data_source][this.chart_data[0]][this.chart_freq].map(e => new Date(e.time * 1000)), this.indicatorMovingAverage().period(this.sma_window)(this.historical[this.minutely_data_source][this.chart_data[0]][this.chart_freq].map(e => e.close)))
                }
                return []
            },
            chart_data_ema() {
                if (!this.exponentialMovingAverage || !this.chart_data) return []
                if (this.historical && this.minutely_data_source && this.historical[this.minutely_data_source] && this.historical[this.minutely_data_source][this.chart_data[0]]) {
                    return d3.zip(this.historical[this.minutely_data_source][this.chart_data[0]][this.chart_freq].map(e => new Date(e.time * 1000)), this.indicatorExponentialMovingAverage().period(this.ema_window)(this.historical[this.minutely_data_source][this.chart_data[0]][this.chart_freq].map(e => e.close)))
                }
                return []
            },
            todaysprices() {
                return Object.fromEntries(this.cryptocompare_prices)
            },
            historical() {
                return this.datapoints.reduce((a, c) => {
                    if (!a[c.platform]) a[c.platform] = {};
                    if (!a[c.platform][c.symbol]) a[c.platform][c.symbol] = {};
                    if (!a[c.platform][c.symbol].minutely) a[c.platform][c.symbol].minutely = [];
                    a[c.platform][c.symbol].minutely.push(c);

                    if (!a[c.platform][c.symbol][c.freq]) a[c.platform][c.symbol][c.freq] = [];
                    a[c.platform][c.symbol][c.freq].push(c);


                    return a;
                }, {});
            },
            coin_info_df() {
                return new DataFrame(this.coins, ['name', 'symbol', 'id_coinmarketcap', 'name_coinmarketcap', 'id_coingecko', 'name_coingecko'])
            },
        },
        el: "#app",
        data: {
            datapoints: [],
            api_key: '583932a385edf4530535beb8494248479013f3b340bd5e52368f84b29e227492',
            chart_data: null,
            grabbed_data: null,
            coins,
            colors,
            console,
            cryptocompare_prices: [],
            cryptocompare_historical,
            d3,
            drag,
            minute_OHLC: true,
            c_price: true,
            freq: 'MIN',
            minutely_data_source: "cryptocompare",
            ticker_c: null,
            tickers,
            simpleMovingAverage,
            exponentialMovingAverage,
            sma: false,
            ema: false,
            ema_color: '#FF0000',
            ema_window: 10,
            sma_color: '#00FF00',
            sma_window: 10,
            indicatorMovingAverage: null,
            indicatorExponentialMovingAverage: null,
            chart_data_sma_periods: 3,
            chart_freq: 60,
            settings: false,
            watch: true,
            MIN_last_update: 0,
            MIN: false,
            HOU: true,
            HOU_last_update: {},
            DAY: false,
            MON: false

        },
        async mounted() {
            cryptxgang_db = new Dexie("cryptxgang_db");
            // let foo = await Dexie.exists(settings);
            // console.log(foo)
            cryptxgang_db.version(1).stores({
                settings: 'name,value',
                data: '[freq+symbol+time],platform,freq,symbol,close,conversionSymbol,conversionType,high,low,open,time,volumefrom,volumeto'

            });
            cryptxgang_db.on('changes', function (changes) {
                changes.forEach(function (change) {
                    switch (change.type) {
                        case 1: // CREATED
                            console.log('An object was created: ' + JSON.stringify(change.obj));
                            Promise.all(app.tickers.map(async e => await cryptxgang_db.data.where('symbol').equals(e).toArray())).then(e => app.datapoints = [].concat(...e))
                            break;
                        case 2: // UPDATED
                            if (change.key === "tickers") app.tickers = change.mods;
                            console.log('An object with key ' + change.key + ' was updated with modifications: ' + JSON.stringify(change.mods));
                            break;
                        case 3: // DELETED
                            console.log('An object was deleted: ' + JSON.stringify(change.oldObj));
                            break;
                    }
                });
            });
            // cryptxgang_db.data.hook("updating", function (mods, primKey, obj, trans) {
            //     console.log({ obj })
            // })
            //
            // Put some data into it
            //

            // cryptxgang_db.settings.put({ name: "tickers", value: ['ONE', 'BTC'] }).then(function () {
            // //     //
            // //     // Then when data is stored, read from it
            // //     //
            // return cryptxgang_db.settings.get('tickers');
            // })


            // Promise.resolve(cryptxgang_db.settings.get('tickers'))
            new Promise(async function (resolve, reject) {
                await cryptxgang_db.settings.get('tickers').then(async e => {
                    if (e && e.value) return resolve(e.value);
                    e = ['ONE', 'BTC'];
                    await cryptxgang_db.settings.put({ name: "tickers", value: e }).then(f => resolve(e))
                })
            })
                .then(async function (value) {
                    app.tickers = value;
                    let h = {};
                    // let foobar = await Promise.all(app.tickers.map(async e => await cryptxgang_db.data.where('freq').equals(60).and(dp => dp.symbol === e).toArray()))

                    let foobar = await Promise.all(app.tickers.map(async e => await cryptxgang_db.data.where('symbol').equals(e).toArray()))
                    Promise.all(app.tickers.map(async e => await cryptxgang_db.data.where('symbol').equals(e).toArray())).then(e => console.log(e))
                    console.log(app.datapoints = [].concat(...foobar));



                    _heartbeat(app.get_price_from_cryptocompare, 20000);
                    _heartbeat(app.get_minutely_from_cryptocompare, 45000);

                }).catch(function (error) {
                    //
                    // Finally don't forget to catch any error
                    // that could have happened anywhere in the
                    // code blocks above.
                    //
                    alert("Ooops: " + error);
                });
            // _heartbeat(_thump1);
            // _heartbeat(_thump2, 5000);
            // fetch('https://min-api.cryptocompare.com/data/pricemultifull?fsyms=ONE,BTC,VET,MATIC,ALGO&tsyms=USD').then(e => e.json()).then(e => this.cryptocompare_prices = Object.entries(e.RAW))
        }
    });

    function wait(ms) { return new Promise((r, j) => setTimeout(r, ms)); }


    function DataFrame(data, col_headers, rows_labels) {
        if (!col_headers) col_headers = data.splice(0, 1)[0];
        let rows = {};
        data = data.filter(r => r.some(rr => rr));
        data.forEach((e, i) => {
            e.forEach((ee, ii) => {
                (rows[ee.toString()] || (rows[ee.toString()] = [])).push([i.toString(), ii.toString()])
            })
        })
        let
            cols = col_headers.reduce((a, c, i) => {
                a[c] = data.map(e => e[i]);
                return a;
            }, {})
        return {
            col(col_name) {
                if (!col_name) return col_headers
                return cols[col_name]
            },
            row(row_value, col_name) {
                if (!row_value) return data.map(r => Object.fromEntries(d3.zip(col_headers, r)));
                if (col_name) return rows[row_value] && rows[row_value].map(r => data[r[0]]).filter(r => r[col_headers.indexOf(col_name)] == row_value).map(r => d3.zip(col_headers, r)).map(r => Object.fromEntries(r));
                return rows[row_value] && Array.from(new Set(rows[row_value].map(r => r[0]))).map(r => data[r[0]]);
            }
        };
    }
    String.prototype.hashCode = function () {
        var hash = 0, i, chr;
        if (this.length === 0) return hash;
        for (i = 0; i < this.length; i++) {
            chr = this.charCodeAt(i);
            hash = ((hash << 5) - hash) + chr;
            hash |= 0; // Convert to 32bit integer
        }
        return hash;
    };


    function get_cryptocompare_minutely(symbol) {
        // return console.log()

        return fetch(`https://min-api.cryptocompare.com/data/v2/histominute?fsym=${symbol}&tsym=USD&limit=300`).then(e => e.json()).then(e => e.Data.Data)

    }
    function get_cryptocompare_hourly(symbol) {
        // return console.log()

        return fetch(`https://min-api.cryptocompare.com/data/v2/histohour?fsym=${symbol}&tsym=USD&limit=300`).then(e => e.json()).then(e => e.Data.Data)

    }

    function get_cryptocompare_prices(array) {
        // return fetch(`https://min-api.cryptocompare.com/data/pricemultifull?fsyms=${array.join(',')}&tsyms=USD}`).then(e => e.json()).then(e => e)
        return fetch(`https://min-api.cryptocompare.com/data/pricemultifull?fsyms=${array.join(',')}&tsyms=USD`).then(e => e.json()).then(e => e)

    }

    async function _thump1() {
        console.log('getting today\'s prices from cryptcompare...');
        let foo = await get_cryptocompare_prices(['ONE', 'BTC', 'VET', 'MATIC', 'ALGO', 'ETH', 'GRV', 'USDT']).then(e => this.cryptocompare_prices = Object.entries(e.RAW));
        app.cryptocompare_prices = foo;
    }

    async function _thump2() {
        console.log('getting today\'s winners and losers...')
        // let foo = await get_cryptocompare_prices(['ONE', 'BTC', 'VET', 'MATIC', 'ALGO']).then(e => this.cryptocompare_prices = Object.entries(e.RAW));
        // app.cryptocompare_prices = foo;
    }

    async function _heartbeat(func, wait_time = 15000) {
        if (!func) return 0;
        await func();
        return setTimeout(async () => {
            // while (_paused) await wait(1000);
            return _heartbeat(func, wait_time);
        }, wait_time)
    };

    function allowDrop(ev) {
        ev.preventDefault();
    }

    function drag(e) {
        app.grabbed_data = e;
        return console.log(e)
        // if(ev.coord_array)return console.log(ev.coord_array)
        // app.dragged_object = ev;
        // ev.dataTransfer.setData("obj", ev.target.className);
    }

    function drop(e) {
        return console.log((app.chart_data = app.grabbed_data) && (app.grabbed_data = null))
        ev.preventDefault();
        // let el  = ev.dataTransfer.getData("obj");
        // console.log(app.dragged_object)
        // // console.log(ev.clientX-(app.dragged_object.target.offsetWidth/2), ev.clientY-(app.dragged_object.target.offsetHeight/2), ev.dataTransfer.getData("obj"), ev.target.offsetTop);
        // console.log(ev.clientX, ev.clientY, ev.dataTransfer.getData("obj"), ev.target.offsetTop);
        // app.presentation_sources.push([ev.clientX, ev.clientY, ev.dataTransfer.getData("obj")])
        // ev.dataTransfer.setData("obj", app.dragged_object = null);
        //   var data = ev.dataTransfer.getData("text");
        //   ev.target.appendChild(document.getElementById(data));
    }

    // https://blog.oliverjumpertz.dev/the-moving-average-simple-and-exponential-theory-math-and-implementation-in-javascript
    function simpleMovingAverage(prices, window = 5, n = Infinity) {
        if (!prices || prices.length < window) {
            return [];
        }

        let index = window - 1;
        const length = prices.length + 1;

        const simpleMovingAverages = [];

        let numberOfSMAsCalculated = 0;

        while (++index < length && numberOfSMAsCalculated++ < n) {
            const windowSlice = prices.slice(index - window, index);
            const sum = windowSlice.reduce((prev, curr) => prev + curr, 0);
            simpleMovingAverages.push(sum / window);
        }

        return simpleMovingAverages;
    }

    function exponentialMovingAverage(prices, window = 5) {
        if (!prices || prices.length < window) {
            return [];
        }

        let index = window - 1;
        let previousEmaIndex = 0;
        const length = prices.length;
        const smoothingFactor = 2 / (window + 1);

        const exponentialMovingAverages = [];

        const [sma] = simpleMovingAverage(prices, window, 1);
        exponentialMovingAverages.push(sma);

        while (++index < length) {
            const value = prices[index];
            const previousEma = exponentialMovingAverages[previousEmaIndex++];
            const currentEma = (value - previousEma) * smoothingFactor + previousEma;
            exponentialMovingAverages.push(currentEma);
        }

        return exponentialMovingAverages;
    }

</script>

</html>