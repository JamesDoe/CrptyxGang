<!DOCTYPE html>
<html lang="en">

<head>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css?family=Teko|Roboto+Condensed|Roboto" rel="stylesheet">

    <!-- <link href="https://fonts.googleapis.com/css2?display=swap&family=Roboto+Condensed|Roboto" rel="stylesheet"> -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://unpkg.com/vue"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.0.1/d3.min.js"
        integrity="sha512-1e0JvdNhUkvFbAURPPlFKcX0mWu/b6GT9e0uve7BW4MFxJ15q4ZCd/Llz+B7/oh+qhw7/l6Q1ObPt6aAuR01+Q=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.socket.io/3.1.3/socket.io.min.js"
        integrity="sha384-cPwlPLvBTa3sKAgddT6krw0cJat7egBga3DJepJyrLl4Q9/5WLra3rrnMcyTyOnh"
        crossorigin="anonymous"></script>


    <title>Document</title>
    <style>
        text {
            pointer-events: none;
        }

        body {
            background-color: #999;
        }

        .material-field {
            /* margin: 1em; */
            position: relative;
        }

        /* .6_17 { 
	overflow:hidden;
} */
        .button,
        select,
        input {
            font-size: 18px;
            padding: 13px 15px;
            /* margin-bottom: 20px; */
            width: calc("100% - 30px");
            display: block;
            border-radius: 5px;
            border: 2px solid gray;
        }

        input:focus {
            outline: none;
            border: 2px solid dodgerb;
        }

        input:focus.material-field-label {
            color: dodgerb;
            transform: scale(.75) translate(-13px, -30px);
        }

        .input_filled~.material-field-label,
        select:focus~.material-field-label,
        input:focus~.material-field-label {
            color: dodgerb;
            transform: scale(.75) translate(-13px, -30px);
        }

        label {
            color: #ccc;
            background: #fff;
            font-size: 16px;
            font-weight: normal;
            position: absolute;
            pointer-events: none;
            top: 15px;
            left: 8px;
            padding: 0 8px;
            transition: 150ms cubic-bezier(0.4, 0, 0.2, 1) all;
            -moz-transition: 150ms cubic-bezier(0.4, 0, 0.2, 1) all;
            -webkit-transition: 150ms cubic-bezier(0.4, 0, 0.2, 1) all;
        }

        .e6_17 {
            width: 180px;
            height: 84.9056625366211px;
            position: relative;
            margin: .38em;
        }

        .e1_2 {
            box-shadow: 0px 0.4245283007621765px 1.698113203048706px rgba(0, 0, 0, 0.25);
            /* background-color: rgba(255, 255, 255, 1); */
            background-color: #fefefe;
            width: 180px;
            height: 84.9056625366211px;
            /* position:absolute; */
            left: 0px;
            top: 0px;
            border-radius: 3.8207547664642334px;
        }

        .e1_2_1 {
            box-shadow: 0px 0.4245283007621765px 1.698113203048706px rgba(0, 0, 0, 0.25);
            background-color: rgba(255, 255, 255, 1);
            /* width: 180px; */
            /* height: 84.9056625366211px; */
            /* position:absolute; */
            /* left: 0px; */
            /* top: 0px; */
            /* display: inline-flex; */
            padding: 1em;
            border-radius: 3.8207547664642334px;
        }

        .ticker_name {
            color: black;
            width: 78.96226501464844px;
            height: 10.188679695129395px;
            position: absolute;
            left: 9px;
            top: 67.5px;
            font-family: Roboto;
            text-align: left;
            font-size: 10.188679695129395px;
            letter-spacing: 0;
        }

        .e6_18 {
            color: rgba(187.00000405311584, 187.00000405311584, 187.00000405311584, 1);
            width: 78.96226501464844px;

            height: 10.188679695129395px;
            position: absolute;
            right: 9px;
            top: 67.5px;
            font-family: Roboto;
            text-align: right;
            font-size: 10.188679695129395px;
            letter-spacing: 0;
        }

        .ticker {
            opacity: 0.62;
            color: rgba(119.00000050663948, 119.00000050663948, 119.00000050663948, 1);
            width: 158.34906005859375px;
            height: 37.97288513183594px;
            position: absolute;
            font-weight: 600;
            left: 6.79248046875px;
            top: 25.59967041015625px;
            font-family: 'Roboto Condensed';
            text-align: left;
            font-size: 40.75471878051758px;
            letter-spacing: 0;
        }

        .e6_7 {
            font-weight: 900;

            color: rgba(0, 0, 0, 1);
            width: 96.36792755126953px;
            height: 23.03972816467285px;
            position: absolute;
            left: 6.79248046875px;
            top: 6.8265380859375px;
            font-family: 'Roboto Condensed';
            text-align: left;
            font-size: 20.37735939025879px;
            letter-spacing: 0;

        }

        .percent_change {
            color: #222;
            width: 56.88679885864258px;
            height: 20.47975730895996px;
            position: absolute;
            left: 103.160400390625px;
            top: 11px;
            font-family: 'Roboto Condensed';
            text-align: left;
            font-size: 15.283019065856934px;
            letter-spacing: 0;
            font-weight: 900;

        }

        .time_scale_option_9 {
            color: #BBB;
            /* width: 13.160377502441406px; */
            height: 6px;
            position: absolute;
            left: 108px;
            font-family: 'Roboto';
            text-align: center;
            /* font-size: 5.94339656829834px; */
            letter-spacing: 0;
            font-weight: 900;
            display: flex;
            align-items: center;
            text-rendering: optimizeLegibility;
        }

        .time_scale_option_9>span {
            padding: 0 1.5px;
            opacity: .8;
            user-select: none;
        }

        .time_scale_option_9>span:hover {
            opacity: 1;
            color: dodgerb;
            font-weight: 900;
            cursor: pointer;
        }

        [class^='time_scale_option_'] {


            font-size: 8px;
            top: 4px;
            font-family: 'Roboto';
        }

        /* https://www.w3schools.com/css/css_tooltip.asp */
        .tooltip {
            position: relative;
            display: inline-block;
            border-bottom: 1px dotted black;
            /* If you want dots under the hoverable text */
        }

        /* Tooltip text */
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 120px;
            background-color: black;
            color: #BBB;
            text-align: center;
            padding: 5px 0;
            border-radius: 6px;

            /* Position the tooltip text - see examples below! */
            position: absolute;
            z-index: 1;
        }

        /* Show the tooltip text when you mouse over the tooltip container */
        .tooltip:hover .tooltiptext {
            visibility: visible;
        }

        input {
            border: 0;
        }

        input:focus {
            outline: none;
        }

        .uname {
            font-size: .62em;
            text-transform: uppercase;
        }

        .time_display {
            font-size: 2.62em
        }

        .points_display {
            font-size: 1.62em
        }

        nav>a>svg {
            fill: #777
        }


        .drawing, .tools svg:hover{
            cursor: pointer;
            fill: dodgerblue;
        }

        
        nav>a:focus>svg,
        nav>a>svg:hover {
            fill: dodgerblue;
        }

        text {
            user-select: none;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dexie/3.2.0-rc.2/dexie.min.js"
        integrity="sha512-hJ1eR4h0vQbaojZAlCt5mDHE255IeqdRpK4IyBnXvAYDyBYfxMu2V2CA8PLAh8DdLB6x9ei9GRs+v2dUIGIjDQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/dexie-observable@3.0.0-beta.11/dist/dexie-observable.min.js"></script>

</head>

<body>
    <div id="app">
        <div style="background-color: #CCC; padding: 1em; width: 322.2271896769px">
            <nav>
                <a href="#">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24">
                        <path d="M11 5c-1.629 0-2.305-1.058-4-3h-7v20h24v-17h-13z" /></svg>
                    <!-- <path style="stroke: #0ff; filter: url(#glow);" d="M11 5c-1.629 0-2.305-1.058-4-3h-7v20h24v-17h-13z" /></svg> -->
                </a>
                <a href="#">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24">
                        <path
                            d="M23.832 19.641l-6.821-6.821c2.834-5.878-1.45-12.82-8.065-12.82-4.932 0-8.946 4.014-8.946 8.947 0 6.508 6.739 10.798 12.601 8.166l6.879 6.879c1.957.164 4.52-2.326 4.352-4.351zm-14.886-4.721c-3.293 0-5.973-2.68-5.973-5.973s2.68-5.973 5.973-5.973c3.294 0 5.974 2.68 5.974 5.973s-2.68 5.973-5.974 5.973z" />
                    </svg>
                </a>
                <a href="#">
                    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24">
                        <path
                            d="M15 12c0 1.657-1.343 3-3 3s-3-1.343-3-3c0-.199.02-.393.057-.581 1.474.541 2.927-.882 2.405-2.371.174-.03.354-.048.538-.048 1.657 0 3 1.344 3 3zm-2.985-7c-7.569 0-12.015 6.551-12.015 6.551s4.835 7.449 12.015 7.449c7.733 0 11.985-7.449 11.985-7.449s-4.291-6.551-11.985-6.551zm-.015 12c-2.761 0-5-2.238-5-5 0-2.761 2.239-5 5-5 2.762 0 5 2.239 5 5 0 2.762-2.238 5-5 5z">
                        </path>
                    </svg>


                    </svg>
                </a>

                <div
                    style="box-shadow: 0px 0.381945005047435px 1.61821197083685px rgba(0, 0, 0, 0.25); background-color: #fefefe; border-radius: 2.61846597222792px; width: 322.2271896769px; height: 185.4101966px">
                    <Chart :symbol="'BTC'" :chartsymbol="'BTC'"
                        :todaysprice="todaysprices['BTC']&&todaysprices['BTC'].USD.PRICE||0"></Chart>
                </div>
                <div style="box-shadow: 0px 0.381945005047435px 1.61821197083685px rgba(0, 0, 0, 0.25);
                    background-color: #fefefe;
        
                    border-radius: 2.61846597222792px; width: 123.066297190163px; height: 76.054971663521px">
                    <div style='font-family: "Roboto Condensed"; color: black; font-size: 0.8em;'>
                        <span style="user-select: none;height: 24px;line-height: 24px">
                            Hourly OHLC Data:
                        </span>
                        <span style="display: inline-block; height: 24px" @click="HOU=!HOU">
                            <svg style="padding: 0; margin: 0; pointer-events:none;" v-if="!HOU" width="24" height="24"
                                xmlns="http://www.w3.org/2000/svg" fill="lightgray" fill-rule="evenodd"
                                clip-rule="evenodd">
                                <path
                                    d="M18 18h-12c-3.311 0-6-2.689-6-6s2.689-6 6-6h12.039c3.293.021 5.961 2.701 5.961 6 0 3.311-2.688 6-6 6zm-12-10c2.208 0 4 1.792 4 4s-1.792 4-4 4-4-1.792-4-4 1.792-4 4-4z" />
                            </svg>
                            <svg style="padding: 0; margin: 0; pointer-events:none;" v-else width="24" height="24"
                                xmlns="http://www.w3.org/2000/svg" fill="dodgerblue" fill-rule="evenodd"
                                clip-rule="evenodd">
                                <path
                                    d="M6 18h12c3.311 0 6-2.689 6-6s-2.689-6-6-6h-12.039c-3.293.021-5.961 2.701-5.961 6 0 3.311 2.688 6 6 6zm12-10c-2.208 0-4 1.792-4 4s1.792 4 4 4 4-1.792 4-4-1.792-4-4-4z" />
                            </svg>
                        </span>
                    </div>
                    <div style='font-family: "Roboto Condensed"; color: black; font-size: 0.8em;'>
                        <span style="user-select: none;height: 24px;line-height: 24px">
                            Daily OHLC Data:
                        </span>
                        <span style="display: inline-block; height: 24px" @click="DAY=!DAY">
                            <svg style="padding: 0; margin: 0; pointer-events:none;" v-if="!DAY" width="24" height="24"
                                xmlns="http://www.w3.org/2000/svg" fill="lightgray" fill-rule="evenodd"
                                clip-rule="evenodd">
                                <path
                                    d="M18 18h-12c-3.311 0-6-2.689-6-6s2.689-6 6-6h12.039c3.293.021 5.961 2.701 5.961 6 0 3.311-2.688 6-6 6zm-12-10c2.208 0 4 1.792 4 4s-1.792 4-4 4-4-1.792-4-4 1.792-4 4-4z" />
                            </svg>
                            <svg style="padding: 0; margin: 0; pointer-events:none;" v-else width="24" height="24"
                                xmlns="http://www.w3.org/2000/svg" fill="dodgerblue" fill-rule="evenodd"
                                clip-rule="evenodd">
                                <path
                                    d="M6 18h12c3.311 0 6-2.689 6-6s-2.689-6-6-6h-12.039c-3.293.021-5.961 2.701-5.961 6 0 3.311 2.688 6 6 6zm12-10c-2.208 0-4 1.792-4 4s1.792 4 4 4 4-1.792 4-4-1.792-4-4-4z" />
                            </svg>
                        </span>
                    </div>
                </div>
                <!-- <div class="e1_2_1">
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24">
                            <path
                                d="M15 12c0 1.657-1.343 3-3 3s-3-1.343-3-3c0-.199.02-.393.057-.581 1.474.541 2.927-.882 2.405-2.371.174-.03.354-.048.538-.048 1.657 0 3 1.344 3 3zm-2.985-7c-7.569 0-12.015 6.551-12.015 6.551s4.835 7.449 12.015 7.449c7.733 0 11.985-7.449 11.985-7.449s-4.291-6.551-11.985-6.551zm-.015 12c-2.761 0-5-2.238-5-5 0-2.761 2.239-5 5-5 2.762 0 5 2.239 5 5 0 2.762-2.238 5-5 5z">
                            </path>
                        </svg>
                        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24">
                            <path
                                d="M24 13.616v-3.232l-2.869-1.02c-.198-.687-.472-1.342-.811-1.955l1.308-2.751-2.285-2.285-2.751 1.307c-.613-.339-1.269-.613-1.955-.811l-1.021-2.869h-3.232l-1.021 2.869c-.686.198-1.342.471-1.955.811l-2.751-1.308-2.285 2.285 1.308 2.752c-.339.613-.614 1.268-.811 1.955l-2.869 1.02v3.232l2.869 1.02c.197.687.472 1.342.811 1.955l-1.308 2.751 2.285 2.286 2.751-1.308c.613.339 1.269.613 1.955.811l1.021 2.869h3.232l1.021-2.869c.687-.198 1.342-.472 1.955-.811l2.751 1.308 2.285-2.286-1.308-2.751c.339-.613.613-1.268.811-1.955l2.869-1.02zm-12 2.384c-2.209 0-4-1.791-4-4s1.791-4 4-4 4 1.791 4 4-1.791 4-4 4z">
                            </path>
                        </svg> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24">
                            <path
                                d="M5.633 22.031c1.135 1.313 3.735 1.969 6.334 1.969 2.601 0 5.199-.656 6.335-1.969.081-.404 3.698-18.468 3.698-18.882 0-2.473-7.338-3.149-10-3.149-4.992 0-10 1.242-10 3.144 0 .406 3.556 18.488 3.633 18.887zm6.418-16.884c-4.211 0-7.625-.746-7.625-1.667s3.414-1.667 7.625-1.667 7.624.746 7.624 1.667-3.413 1.667-7.624 1.667z">
                            </path>
                        </svg>
                        <svg width="24" height="24" xmlns="http://www.w3.org/2000/svg" fill-rule="evenodd" clip-rule="evenodd">
                            <path
                                d="M18 18h-12c-3.311 0-6-2.689-6-6s2.689-6 6-6h12.039c3.293.021 5.961 2.701 5.961 6 0 3.311-2.688 6-6 6zm-12-10c2.208 0 4 1.792 4 4s-1.792 4-4 4-4-1.792-4-4 1.792-4 4-4z">
                            </path>
                        </svg> <svg width="24" height="24" xmlns="http://www.w3.org/2000/svg" fill-rule="evenodd"
                            clip-rule="evenodd">
                            <path
                                d="M6 18h12c3.311 0 6-2.689 6-6s-2.689-6-6-6h-12.039c-3.293.021-5.961 2.701-5.961 6 0 3.311 2.688 6 6 6zm12-10c-2.208 0-4 1.792-4 4s1.792 4 4 4 4-1.792 4-4-1.792-4-4-4z">
        
                            </path>
                        </svg></div> -->



            </nav>
        </div>
        <!-- <svg height="300" width="824">
            <g class="svgWrapper" transform="translate(412,150)">
                <defs>
                    <filter id="glow">
                        <fegaussianblur class="blur" result="coloredBlur" stddeviation="4"></fegaussianblur>
                        <femerge>
                            <femergenode in="coloredBlur"></femergenode>
                  <femergenode in="coloredBlur"></femergenode>
                  <femergenode in="coloredBlur"></femergenode>
                            <femergenode in="SourceGraphic"></femergenode>
                        </femerge>
                    </filter>
                </defs>
             <path class="exampleGlow" d="M100,250 C100,100 400,100 400,250" style="fill-opacity: 0; stroke-width: 2; stroke: red; filter: url(#glow);" transform="translate(-250,-200)"/></path>
            </g></svg> -->



        <div>
            <div style="display:flex; flex-direction: column ;align-items: center;">
                <div class="time_display" style="text-align: center; width: 100%;">
                    <span v-if="Number(time.split(':')[0]) > 0 || Number(time.split(':')[1]) > 0">{{time}}</span>
                    <span v-else>You {{'win!'}}</span>
                </div>
                <div style="width: 100%;">
                    <div style="display:flex;width: 100%;justify-content: center; align-items: center;">

                        <span class="uname" style="text-align: right; flex: 1; padding: 0 .62em">Randomly Generated User
                            IDs
                        </span>
                        <span class="uname" style="flex: 1;padding: 0 .62em ">
                            AI
                        </span>
                    </div>
                </div>
                <div style="width: 100%;">
                    <div style="display:flex;width: 100%;justify-content: center; align-items: center;">

                        <span style=" flex: 1; ">
                            <div style="display: flex; align-items: center; justify-content: end">
                                <span class="points_display">
                                    {{fantasy_points[1]*(fantasy_points[0].length&&Math.max(confidence_boost(1/d3.mean([1,fantasy_points[0].length]))/100, 1)||1)}}
                                    confidence boost: <span
                                        v-if="fantasy_points[0].length">+{{ confidence_boost(fantasy_points[0].length/d3.mean([1,fantasy_points[0].length])) - 100 }}%</span>
                                    <span>
                                    </span>
                                </span>
                                <svg width="62px" viewbox="0 0 16 16">
                                    <g>
                                        <rect :x='i%16' :y="Math.floor(i/16)" :style="`fill:${p}`"
                                            v-for="p,i in my_random_id.map(e=>palette_to_hex[getRandomInt(255)])"
                                            width="1" height="1"></rect>
                                    </g>
                                </svg>
                            </div>




                        </span>
                        <span style="flex: 1; ">
                            <div style="display: flex; align-items: center;">
                                <svg width="62px" viewbox="0 0 16 16">
                                    <g>
                                        <rect :x='i%16' :y="Math.floor(i/16)" :style="`fill:${p}`"
                                            v-for="p,i in my_id.map(e=>'#'+e.map(f=>f.toString(16)).join('').toUpperCase())"
                                            width="1" height="1"></rect>
                                    </g>
                                </svg>
                                <span class="points_display">
                                    {{state.points*(todaysprices.USDT&&todaysprices.USDT.USD.PRICE||1)*Math.max(confidence_boost(1/d3.mean([1,fantasy_points[0].length]))/100,1)}}
                                    confidence boost: <span
                                        v-if="fantasy_points[0].length">+{{ confidence_boost(1/d3.mean([1,fantasy_points[0].length])) - 100 }}%</span>

                                </span>
                            </div>
                        </span>
                    </div>
                </div>

            </div>

            <!--  [[[x_loc, y_loc] for y_loc in range(16)] for x_loc in [loc for loc in range(16)]]

>>> [list(list(im.getpixel(r)) for r in row) for row in [[tuple([x_loc, y_loc]) for y_loc in range(16)] for x_loc in [loc for loc in range(16)]] ]
[[[204, 204, 204], [204, 204, 204], [203, 203, 203], [204, 204, 204], [204, 204, 204], [204, 204, 204], [204, 204, 204], [204, 204, 204], [204, 204, 204], [187, 187, 187], [170, 170, 170], [136, 136, 136], [136, 136, 136], [119, 119, 119], [136, 136, 136], [119, 119, 119]], [[221, 221, 221], [221, 221, 221], [221, 221, 221], [221, 221, 221], [221, 221, 221], [221, 221, 221], [221, 221, 221], [220, 220, 220], [221, 221, 221], [204, 204, 204], [136, 136, 136], [85, 85, 85], [85, 85, 85], [119, 119, 119], [136, 136, 136], [170, 170, 170]], [[221, 221, 221], [221, 221, 221], [221, 221, 221], [204, 204, 204], [204, 204, 204], [204, 204, 204], [187, 187, 187], [187, 187, 187], [204, 204, 204], [221, 221, 221], [187, 187, 187], [153, 153, 153], [85, 85, 85], [170, 170, 170], [153, 153, 153], [85, 85, 85]], [[221, 221, 221], [187, 187, 187], [85, 85, 85], [85, 85, 85], [103, 103, 103], [68, 68, 68], [51, 51, 51], [51, 51, 51], [68, 68, 68], [101, 101, 101], [153, 153, 153], [170, 170, 170], [221, 221, 221], [170, 170, 170], [85, 85, 85], [136, 136, 136]], [[204, 204, 204], [136, 136, 136], [102, 102, 102], [68, 68, 68], [51, 51, 51], [51, 51, 51], [51, 51, 51], [51, 51, 51], [51, 51, 51], [51, 51, 51], [85, 85, 85], [68, 68, 68], [85, 85, 85], [51, 51, 51], [34, 34, 34], [34, 34, 34]], [[170, 170, 170], [102, 102, 102], [119, 119, 119], [136, 136, 136], [136, 136, 136], [51, 51, 51], [51, 51, 51], [85, 85, 85], [85, 85, 85], [68, 68, 68], [51, 51, 51], [51, 51, 51], [51, 51, 51], [68, 68, 68], [85, 85, 85], [85, 85, 85]], [[102, 102, 102], [170, 170, 170], [221, 221, 221], [221, 221, 221], [136, 136, 136], [51, 51, 51], [34, 34, 34], [67, 67, 67], [136, 136, 136], [102, 102, 102], [85, 85, 85], [102, 102, 102], [68, 68, 68], [51, 51, 51], [68, 68, 68], [85, 85, 85]], [[85, 85, 85], [204, 204, 204], [238, 238, 238], [238, 238, 238], [136, 136, 136], [34, 34, 34], [51, 51, 51], [85, 85, 85], [136, 136, 136], [171, 171, 171], [170, 170, 170], [153, 153, 153], [136, 136, 136], [68, 68, 68], [51, 51, 51], [69, 69, 69]], [[102, 102, 102], [237, 239, 238], [238, 238, 238], [238, 238, 238], [136, 136, 136], [34, 34, 34], [51, 51, 51], [119, 119, 119], [135, 135, 135], [204, 204, 204], [119, 119, 119], [153, 153, 153], [187, 187, 187], [102, 102, 102], [51, 51, 51], [85, 85, 85]], [[102, 102, 102], [237, 237, 237], [239, 237, 238], [238, 238, 238], [170, 170, 170], [68, 68, 68], [187, 187, 187], [221, 221, 221], [119, 119, 119], [119, 119, 119], [119, 119, 119], [135, 135, 135], [170, 170, 170], [102, 102, 102], [51, 51, 51], [85, 85, 85]], [[153, 153, 153], [238, 238, 238], [238, 238, 238], [238, 238, 238], [170, 170, 170], [101, 52, 48], [152, 102, 101], [153, 153, 153], [102, 102, 102], [102, 102, 102], [85, 85, 85], [102, 102, 102], [102, 102, 102], [85, 85, 85], [51, 51, 51], [51, 51, 51]], [[49, 103, 103], [221, 221, 221], [238, 236, 237], [238, 238, 238], [152, 152, 152], [100, 50, 49], [153, 50, 51], [101, 51, 50], [119, 119, 119], [136, 136, 136], [102, 102, 102], [102, 102, 102], [68, 68, 68], [51, 51, 51], [34, 34, 34], [51, 51, 51]], [[102, 102, 102], [170, 170, 170], [221, 221, 221], [203, 204, 206], [203, 153, 152], [153, 50, 51], [153, 50, 51], [101, 51, 50], [85, 85, 85], [68, 68, 68], [51, 51, 51], [68, 68, 68], [51, 51, 51], [34, 34, 34], [34, 34, 34], [51, 51, 51]], [[187, 187, 187], [102, 102, 102], [153, 153, 153], [136, 136, 136], [119, 119, 119], [101, 51, 50], [101, 51, 50], [101, 51, 50], [85, 85, 85], [68, 68, 68], [51, 51, 51], [85, 85, 85], [102, 102, 102], [101, 101, 101], [51, 51, 51], [34, 34, 34]], [[221, 221, 221], [204, 204, 204], [170, 170, 170], [85, 85, 85], [68, 68, 68], [101, 51, 50], [68, 68, 68], [68, 68, 70], [85, 85, 85], [85, 85, 85], [154, 154, 154], [204, 204, 204], [238, 238, 238], [221, 221, 221], [221, 221, 221], [51, 51, 51]], [[238, 238, 238], [222, 222, 222], [221, 221, 221], [187, 187, 187], [136, 136, 136], [119, 119, 117], [136, 136, 136], [171, 169, 170], [187, 187, 187], [187, 187, 187], [204, 204, 204], [204, 204, 204], [221, 221, 221], [238, 238, 238], [187, 187, 187], [136, 136, 136]]]
-->
        </div>
        <div style="display: inline-block" v-if="state.points_to_start">
            <span><span>POINTS</span><span>Fantasy Crypto Points</span></span>
            <span>{{state.points_to_start}}</span>
            <span><button :disabled="swapping=='Fantasy Crypto Points'"
                    @click="swapping=from.symbol='Fantasy Crypto Points'; from.symbol=0; from.amount = state.points_to_start">swap</button></span>
            <!-- <span><button @click="swap(to)">swap</button></span> -->
        </div>
        <div v-if="state[symbol]&&symbol.slice(0,6)!='points'" v-for="amount, symbol in state">
            <!-- <span><span>{{p.symbol}}</span><span>Fantasy Crypto Points</span></span>
            <span></span>
             -->
            {{symbol}} My Ticker Name {{amount}}<span><button :disabled="swapping==symbol"
                    @click="swapping=from.symbol=symbol; from.amount=state[symbol]">swap</button></span>
        </div>
        <!-- <div v-for="t in ticker_symbols">
            <span><span>POINTS</span><span>Fantasy Crypto Points</span></span>
            <span>{{state.points}}</span>
            <span><button>swap</button></span>
        </div> -->
        <!-- {{plays}} -->
        Swap {{swapping}} for which crypto?
        {{swapping}} to
        <div style="display: inline-block" v-if="swapping">
            <span v-if="to.symbol">
                <div style="position: relative; width: auto">
                    <input disabled v-model="to.symbol" type="text" />

                    <span
                        style="text-align: right; height: 47px; width: 100%; line-height: 47px; position: absolute; top: 0; display: inline-block;">
                        <span style="padding-right:1em" @click="to.symbol=''">CLEAR</span>
                    </span>
                </div>
            </span>
            <span v-else>
                <div style="position: relative;">
                    <input v-model="searchterm" type="text" />
                    <span v-if="searchterm" style="text-align: right; top: 47px; position: absolute;">
                        <div style="display:flex; align-items: center; background-color: #FFF; width: auto; padding: 1em;"
                            v-for="c in filter_cryptos.slice(0,5)" @click="to.symbol = c.RAW.USD.FROMSYMBOL;">
                            {{c.CoinInfo.FullName}}</div>
                    </span>
                </div>
            </span>
            How much crypto? <input :max="Number(from.amount)" v-model="from.amount" type="number">

            <span><button @click="swap(to);">Make The Swap</button></span>
            <!-- <div style="position: absolute">
                <div style="display:flex; align-items: center; background-color: #FFF; width: auto; padding: 1em;"
                    v-for="c in filter_cryptos.slice(0,5)" @click="to.symbol = c.RAW.USD.FROMSYMBOL;">
                    
                    <img width="48" :src="'https://cryptocompare.com/'+c.CoinInfo.ImageUrl" alt="">
                        <div>
                            <span style="font-size: 1.62em; display:inline-block">{{c.RAW.USD.FROMSYMBOL}}</span><br>
                            <span style="font-size: 0.8em; display:inline-block">{{c.CoinInfo.FullName}}</span>
                        </div>
    
                </div>
            </div> -->

            <!-- {{ticker_symbols}}
            {{cryptocompare_prices}} -->
        </div>
    </div>
</body>
<script src="palette.js"></script>
<script>

    scale = d3.scaleLinear().domain([0, 1]).range([0, 255]).nice()

    function clut8ColorComponents(n) {
        if (n > 256 || n < 0) n = 255;
        return [scale(palette[n].red), scale(palette[n].blue), scale(palette[n].green)]
        // return pallet[n].map(e => [scale(e.red)])
    }



    function get_cryptocompare_prices(array) {
        // console.log(array)
        // return fetch(`https://min-api.cryptocompare.com/data/pricemultifull?fsyms=${array.join(',')}&tsyms=USD}`).then(e => e.json()).then(e => e)
        return fetch(`https://min-api.cryptocompare.com/data/pricemultifull?fsyms=${array.join(',')}&tsyms=USD&api_key=583932a385edf4530535beb8494248479013f3b340bd5e52368f84b29e227492`).then(e => e.json()).then(e => e)

    }


    // const Chart = {
    //     props: [],
    //     data: function () {
    //         let margin = { top: 0, bottom: 0, left: 0, right: 0 },
    //         padding = { between_candles: 2 },
    //         candle = { width: 3, up: "green", down: "red" },
    //         wick = { width: 1 },
    //         dp = [1, 2, 3],
    //         chart = {};
    //         chart.width = (dp.length * candle.width) + padding.between_candles * (dp.length - 1) + margin.left + margin.right;
    //         // chart.height = margin.top + margin.bottom;

    //         return {
    //             chart
    //         }
    //     },
    //     template: `<div>

    //     <div>`
    // };


    async function _heartbeat(func, wait_time = 15000) {
        if (!func) return 0;
        await func();
        return setTimeout(async () => {
            // while (_paused) await wait(1000);
            return _heartbeat(func, wait_time);
        }, wait_time)
    };
    const colors = ['orange', 'blue', 'indigo', 'violet', 'cyan', 'magenta', 'yellow', 'black']
    Vue.filter('x_label_formatter',
        function (value, freq) {
            // https://stackoverflow.com/questions/13627308/add-st-nd-rd-and-th-ordinal-suffix-to-a-number
            // n=>n+['th','st','nd','rd'][n%100-n%10-10&&n%10<4?n%10:0]
            if (!value) return ''
            value = new Date(value * 1000)
            switch (freq) {
                case 60:
                    return value.getHours() + ':' + value.getMinutes().toString().padStart(2, '0');
                case 360:
                    let n = value.getDate();
                    return (n + ['th', 'st', 'nd', 'rd'][n % 100 - n % 10 - 10 && n % 10 < 4 ? n % 10 : 0]) + value.toLocaleTimeString('en-US', { hour: 'numeric' })
                case 24:
                    return value.toLocaleString('en-US', { month: 'numeric', day: 'numeric' });
                default:
                    return '';
            }

        })
    const app = new Vue({
        components: {
            Chart: {
                props: ['symbol'],
                async mounted() {
                    this.loading = 0;
                },
                computed: {
                    
                    data() {
                        return this.$parent.datapoints && this.$parent.datapoints.filter(e => e.symbol === this.chartsymbol) || []
                    },
                    data_filtered() {
                        return this.data.filter(e => e.freq === this.chart_freq)
                    },
                    freq() {
                        // console.log(this.dp)
                        return this.data_filtered.slice(this.max_datapoints_to_display * (-1) - this.i).slice(0, this.max_datapoints_to_display)
                    },
                    ticks() {
                        return
                    },
                    xscale() {
                        // return d3.scaleTime().domain(d3.extent(this.freq.slice(0, this.max_datapoints_to_display).map(e=>new Date(e.time*1000)))).range([0,100-7.5]).nice()
                        return d3.scaleLinear().domain(d3.extent(this.freq.map(e => e.time))).range([0 + this.margin.left, 322.2271896769 - this.margin.right]).nice()
                    },
                    yscale() {
                        return d3.scaleLinear().domain([Math.min(...this.freq.map(e => e.low)), Math.max(this.todaysprice,...this.freq.map(e => e.high))]).range([185.4101966 - this.margin.bottom, 0 + this.margin.top]).nice()
                    },
                    chart_width() {
                        return (this.candle.width * this.freq.slice(0, this.max_datapoints_to_display).length) + this.padding.between_candles * (this.freq.slice(0, this.max_datapoints_to_display).length - 1) + this.margin.left + this.margin.right
                        // return this.dp.length
                    },
                    todaysprice() {
                        return this.$parent.todaysprices && this.$parent.todaysprices[this.chartsymbol] && this.$parent.todaysprices[this.chartsymbol].USD && this.$parent.todaysprices[this.chartsymbol].USD.PRICE || 0
                    }
                },
                data: function () {
                    let w = 100, h = 62, margin = { top: 50, bottom: 38, left: 14, right: 38 },
                        padding = { between_candles: 2 },
                        candle = { wick: { width: 1 }, width: 2, up: "green", down: "red" },
                        dp = [1, 2, 3],
                        chart = {};
                    // chart.width = (dp.length * candle.width) + margin.left + margin.right;
                    // chart.width = (dp.length * candle.width) + padding.between_candles * (dp.length - 1) + margin.left + margin.right;
                    // chart.height = margin.top + margin.bottom;

                    return {
                        drawing: 0,
                        max_datapoints_to_display: 100,
                        margin,
                        candle,
                        padding,
                        loading: 1,
                        chart,
                        chart_freq: 60,
                        Xscale: '',
                        Yscale: '',
                        console,
                        chartsymbol: this.symbol,
                        i: 0,
                        ta_line: [],
                        ta_lines: []
                    }
                },
                watch: {
                    ta_line(o,n) {
                        console.log(n)
                        if (n.length ===2) this.ta_lines.push(n) && (this.ta_line = []);
                    }
                },
                template: `<div style="font-family: 'Roboto Condensed';position: relative">
                    
                    
    <div style="position: absolute;z-index: 1; opacity: .8">
        <div style="display:flex; align-items: center" v-for="scope in [$parent.todaysprices&&$parent.todaysprices[chartsymbol]&&$parent.todaysprices[chartsymbol].USD]" v-if="$parent.cryptos_asobj&&$parent.cryptos_asobj[chartsymbol]">
            <img width="48" :src="'https://cryptocompare.com/'+$parent.cryptos_asobj[chartsymbol].CoinInfo.ImageUrl" alt="">
            <span style="font-family:'Roboto Condensed';margin-top:.5em; display:flex; flex-direction: column">
                <span style="font-weight: 900; font-size:1.62em">
                    {{$parent.cryptos_asobj&&$parent.cryptos_asobj[chartsymbol]&&$parent.cryptos_asobj[chartsymbol].CoinInfo.Name}}&nbsp;<span v-if="scope&&scope.PRICE" style="font-size:.8em;">\${{scope&&scope.PRICE}}</span>
                    <span @click="chart_freq=f[1]" v-if="data.filter(e => e.freq === f[1]).length" v-for="f in [['MIN',60],['HOU',360],['DAY',24],['MONTH',30]]" :style="\`color: \${chart_freq!==f[1]?'#BBB':'dodgerblue'}; text-align: center; letter-spacing: 0; font-weight: 900; text-rendering: optimizeLegibility; font-size: 8px; font-family: 'Roboto';\`">
                        {{f[0]}}
                    </span>
                </span>
                <span style="color: black; position: relative; top:-.38em;">
                    <span style="font-size:.8em;">{{$parent.cryptos_asobj&&$parent.cryptos_asobj[chartsymbol]&&$parent.cryptos_asobj[chartsymbol].CoinInfo.FullName}}</span>
                    <span v-if="scope" style="font-size:.5em; background: linear-gradient(rgba(255,255,255,.09), rgba(255,255,255,.38), rgba(255,255,255,.09))">
                        <span style="color: #444; font-weight: 600">LASTHR</span><svg :style="Math.round((scope.CHANGEPCTHOUR + Number.EPSILON) * 100) / 100>0?'transform: rotate(270deg);fill: #61FE61':'transform: rotate(90deg);fill: #FF6464'" xmlns="http://www.w3.org/2000/svg" width="9" height="9" viewBox="0 0 24 24">
                            <path d="M24 12l-12-9v5h-12v8h12v5l12-9z" />
                        </svg>{{Math.round((scope.CHANGEPCTHOUR + Number.EPSILON) * 100) / 100}}%
                        <span style="color: #444; font-weight: 600">LAST24</span><svg :style="Math.round((scope.CHANGEPCT24HOUR + Number.EPSILON) * 100) / 100>0?'transform: rotate(270deg);fill: #61FE61':'transform: rotate(90deg);fill: #FF6464'" xmlns="http://www.w3.org/2000/svg" width="9" height="9" viewBox="0 0 24 24">
                            <path d="M24 12l-12-9v5h-12v8h12v5l12-9z" />
                        </svg>{{Math.round((scope.CHANGEPCT24HOUR + Number.EPSILON) * 100) / 100}}%
                        <span style="color: #444; font-weight: 600">TODAY</span><svg :style="Math.round((scope.CHANGEPCTDAY + Number.EPSILON) * 100) / 100>0?'transform: rotate(270deg);fill: #61FE61':'transform: rotate(90deg);fill: #FF6464'" xmlns="http://www.w3.org/2000/svg" width="9" height="9" viewBox="0 0 24 24">
                            <path d="M24 12l-12-9v5h-12v8h12v5l12-9z" />
                        </svg>{{Math.round((scope.CHANGEPCTDAY + Number.EPSILON) * 100) / 100}}%
                    </span>
                </span>
            </span>
        </div>
    </div>
    <div v-if="loading"
        style="left: calc(50% - 25px); top: calc(calc(185.4101966px / 2) - 25px); position: absolute; display:inline-block; width: 50px; height: 50px">
        <svg version="1.1" id="L9" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="50%"
            y="50%" viewBox="0 0 100 100" enable-background="new 0 0 0 0" xml:space="preserve">
            <path fill="dodgerblue"
                d="M73,50c0-12.7-10.3-23-23-23S27,37.3,27,50 M30.9,50c0-10.5,8.5-19.1,19.1-19.1S69.1,39.5,69.1,50">
                <animateTransform attributeName="transform" attributeType="XML" type="rotate" dur="1s" from="0 50 50"
                    to="360 50 50" repeatCount="indefinite"></animateTransform>
            </path>
        </svg>
    </div>
    <div v-else style="position: absolute; height: 185.4101966px">
        <svg style="width:322.2271896769px" :viewBox="\`0 0 ${322.2271896769} 185.4101966\`"
            xmlns="http://www.w3.org/2000/svg">
                    <!-- RULES -->
                <line stroke="#EEE" stroke-width="1" v-for="x in xscale.ticks().slice(1).slice(0,-1)" :x1="xscale(x)"
                    :x2="xscale(x)" :y1="yscale(yscale.domain()[1])" :y2="yscale(yscale.domain()[0])" />
                <!-- PRICES -->
                <line stroke="dodgerblue" stroke-width="1" stroke-dasharray="4" :x1="0" :x2="322.2271896769"
                    :y1="yscale(todaysprice)" :y2="yscale(todaysprice)" />
                <rect style="shape-rendering:crispEdges" :y="yscale(y)-6" :x='xscale(xscale.domain()[1])'
                    v-for="y in yscale.domain()" :width='322.2271896769-9' :height='12'></rect>
                <text dominant-baseline="middle" fill="white" text-anchor="middle" style="font-weight:600;font-size:.5em"
                    :y="yscale(y)+1" v-for="y in yscale.domain()" :x="xscale(xscale.domain()[1])+20">{{y}}</text>

                <g>
                    <rect fill="dodgerblue" style="shape-rendering:crispEdges" :y="yscale(todaysprice)-6"
                        :x='xscale(xscale.domain()[1])' :width='322.2271896769-9' :height='12'></rect>
                    <text dominant-baseline="middle" fill="white" text-anchor="middle"
                        style="font-weight:600;font-size:.5em" :y="yscale(todaysprice)+1"
                        :x="xscale(xscale.domain()[1])+20">{{todaysprice}}</text>
                </g>

                <!-- CANDLES -->
                <g :fill="yscale(dp.open)-yscale(dp.close)<0?candle.down:candle.up"
                    v-for="dp, i in freq">
                    <!-- WICK -->
                    <rect style="shape-rendering:crispEdges" :y="yscale(dp.high)" :x='xscale(dp.time)-(candle.wick.width/2)'
                        :width='candle.wick.width'
                        :height='(Math.round(((yscale(dp.low)-yscale(dp.high)) + Number.EPSILON) * 100) / 100)'></rect>
                    <!-- BODY -->
                    <rect style="shape-rendering:crispEdges" :y="Math.max(yscale(dp.open),yscale(dp.close))"
                        :x='xscale(dp.time)-(candle.width/2)' :width='candle.width'
                        :height='(Math.round((Math.abs(yscale(dp.open)-yscale(dp.close)) + Number.EPSILON) * 100) / 100)'>
                    </rect>
                </g>
                <!-- X-Labels -->
                <text text-anchor="middle" style="font-size:.5em" :x="xscale(x)"
                    v-for="x in xscale.ticks().slice(1).slice(0,-1)"
                    :y="yscale(yscale.domain()[0])+(margin.bottom/1.62)">{{x, chart_freq | x_label_formatter}}</text>
                <text text-anchor="middle" style="fill: #333;font-weight: 900;font-size:.5em" x="50%"
                    :y="yscale(yscale.domain()[0])+(margin.bottom/1.2)">{{xscale.domain().map(e=>new Date(e*1000).toLocaleString('en-US')).join(' - ')}}</text>
                 
                     <!-- <g v-for="c in C">
                        
                      
                            <circle :cx="c[0][0]" :cy="c[0][1]" r="3" fill="none" stroke="black"/>
                            <circle :cx="c[0][0]" :cy="c[0][1]" r="3" fill="none" stroke="black"/>
                            <circle :cx="c[1][0]" :cy="c[1][1]" r="3" fill="none" stroke="black"/>  -->    
                            </g>
                            <defs>
                                <marker id="marker" viewBox="0 0 10 10" refX="6" refY="6"
                                    markerWidth="6" markerHeight="6">
                                <circle cx="9" cy="3" r="3" fill="none" stroke="black"/>
                                </marker>
                                <marker id="arrow" viewBox="0 0 10 10" refX="5" refY="5"
                                    markerWidth="6" markerHeight="6"
                                    orient="auto-start-reverse">
                                <path d="M 0 0 L 10 5 L 0 10 z" />
                                </marker>

                                <!-- simple dot marker definition -->
                                <marker id="dot" viewBox="0 0 10 10" refX="5" refY="5"
                                    markerWidth="5" markerHeight="5">
                                <circle cx="5" cy="5" r="3" fill="none" stroke="black" />
                                </marker>
                                <circle id="myCircle" cx="5" cy="5" r="2"/>
                            </defs>
                            <g v-for="c in ta_line"> <!--<text :x="c[0]" :y="c[1]">{{c}}
                                </text> -->
                                <use href="#myCircle" :x="c[0]-5" :y="c[1]-5" fill="none" stroke="black"/>
                                                                </g>
                            <g v-for="c in ta_lines">
                                <line marker-end="url(#arrow)" :x1="Number(c[0][0])" :y1="Number(c[0][1])" :x2="Number(c[1][0])" :y2="Number(c[1][1])" stroke="black" />
<!--                                <text :x="c[0][0]" :y="c[0][1]">{{c}}</text> -->
                            </g>
                    
                <rect @click="if(!drawing)return; ta_line.push([$event.offsetX, $event.offsetY])" style="opacity:0" width="100%" height="100%"></rect>
        </svg>
        <div class="tools" style="display:flex; gap: 6px;align-items: center; position: absolute; top: 1px; right: 6px; z-index: 1; opacity: .8" >
                    <svg @click="chartsymbol=$parent.ticker_symbols[$parent.ticker_symbols.indexOf(chartsymbol)+1===$parent.ticker_symbols.length?0:$parent.ticker_symbols.indexOf(chartsymbol)+1]"  xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24"><path d="M24 22h-24l12-20z"/></svg>
                    <svg   @click="chartsymbol=$parent.ticker_symbols[$parent.ticker_symbols.indexOf(chartsymbol)?$parent.ticker_symbols.indexOf(chartsymbol)-1:$parent.ticker_symbols.length-1]"  style="transform: rotate(180deg)" xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24"><path d="M24 22h-24l12-20z"/></svg>
                    
                    <svg @click="drawing=!drawing" :class="{drawing}" xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24"><path d="M14.078 4.232l-12.64 12.639-1.438 7.129 7.127-1.438 12.641-12.64-5.69-5.69zm-10.369 14.893l-.85-.85 11.141-11.125.849.849-11.14 11.126zm2.008 2.008l-.85-.85 11.141-11.125.85.85-11.141 11.125zm18.283-15.444l-2.816 2.818-5.691-5.691 2.816-2.816 5.691 5.689z"/></svg>
                        <svg @click="console.log(i++, i+max_datapoints_to_display <= data_filtered.length)" style="transform: rotate(180deg)" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"><path d="M17.554 12l-6 6h-3.979l3.093-3h-10.668v-6h10.668l-3.093-3h3.979l6 6zm.446-6h-3.979l6 6-6 6h3.979l6-6-6-6z"/></svg>
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"><path d="M17.554 12l-6 6h-3.979l3.093-3h-10.668v-6h10.668l-3.093-3h3.979l6 6zm.446-6h-3.979l6 6-6 6h3.979l6-6-6-6z"/></svg>
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24"><path d="M24 20.188l-8.315-8.209 8.2-8.282-3.697-3.697-8.212 8.318-8.31-8.203-3.666 3.666 8.321 8.24-8.206 8.313 3.666 3.666 8.237-8.318 8.285 8.203z"/></svg>
                        </div>

    </div>
</div>`
            }
        },

        computed: {
            state() {
                let points, points_to_start = 1000;
                points = 1000;
                let _state = { points, points_to_start }
                this.plays.forEach(e => {
                    // console.log(e.length);
                    e.forEach(f => {
                        Object.entries(f).forEach(g => {
                            _state[g[0]] = (_state[g[0]] || (_state[g[0]] = 0)) + g[1]
                        })
                        // f.forEach(h => { console.log(h); let g = Object.keys(h)[0]; _state[g] = (_state[g] || (_state[g] = 0)) + Object.values(h[0]) })
                    })
                })
                // console.log(Object.entries(_state))
                return _state
            },
            cryptos_asobj() {
                console.log()
                return Object.fromEntries(Array.from(this.cryptos).map(e => [e.symbol, e]))// ? [] : Object.fromEntries(this.cryptos.map(e => [e.CoinInfo.Name, e]))
            },
            filter_cryptos() {
                // return Object.values(this.cryptos).filter(e => e.symbol.toLowerCase().includes(this.searchterm.toLowerCase())).slice(0, 20)
                return Object.values(this.cryptos).filter(e => e.RAW && e.RAW.USD && e.RAW.USD.FROMSYMBOL.toLowerCase().includes(this.searchterm.toLowerCase()) || e.CoinInfo.FullName.toLowerCase().includes(this.searchterm.toLowerCase())).slice(0, 20)
            },
            ticker_symbols() {
                let foo = this.fantasy_points[0].map(e => e[0]);
                // console.log(this.internal_ticker_symbols)
                return Array.from(new Set(foo.concat(this.internal_ticker_symbols.length && this.internal_ticker_symbols || this.default.ticker_symbols)));
            },
            fantasy_points() {
                let foo = Object.entries(this.state).filter(e => e[0].slice(0, 6) != 'points');
                return [foo, d3.sum(foo.map(e => {
                    console.log('prices', this.todaysprices[e[0]])
                    if (!this.todaysprices[e[0]]) return 0;
                    console.log(e[1], this.todaysprices[e[0]].USD.PRICE);
                    return e[1] * this.todaysprices[e[0]].USD.PRICE;
                }))]
            },
            todaysprices() {
                return Object.fromEntries(this.cryptocompare_prices)
            },
            palette_to_hex() {
                return this.palette.map(e => "#" + (scale(e.red).toString(16) + scale(e.green).toString(16) + scale(e.blue).toString(16)).toUpperCase())
            }
        },
        el: "#app",
        data: {
            confidence_boost: (function (samples = [0.5, 1], range = [102, 100]) {
                // confidence_boost: (function (samples = [1, 3], range = [102, 100]) {
                return this.d3.scaleLinear().domain(samples.map(sample => sample / d3.mean(samples))).range(range)
                // return d3.scaleLinear().domain(samples.map(sample => sample / d3.deviation(samples))).range(range)
            }()),
            clut8ColorComponents,
            cryptos: {},
            cryptocompare_prices: [],
            from: {
                symbol: '',
                amount: 5
            },
            to: {
                symbol: '',
                amount: 0
            },
            palette,
            EoG,
            plays: [],
            points: 0,
            searchterm: '',
            start: new Date().getTime(),
            end: new Date().getTime() + EoG * 60 * 1000,
            swapping: null,
            time: '',
            gameover: 0,
            my_id,
            getRandomInt,
            random_id: (function () { return Array(256).fill(null).map(e => getRandomInt(255)) }()),
            my_random_id,
            d3,

            default: {
                ticker_symbols: ['BTC', 'ETH']
            },
            internal_ticker_symbols: [],
            datapoints: [],
            HOU: false,
            DAY: false,
            idle: 1



        },
        methods: {
            teardown() {
                return Promise.all([cryptxgang_db.data.where('freq').equals(60).and(e => e.time < Math.round(Date.now() / 1000) - 60 * 300).delete().then(e => e),
                cryptxgang_db.data.where('freq').equals(360).and(e => e.time < Math.round(Date.now() / 1000) - 60 * 60 * 300).delete().then(e => e),
                cryptxgang_db.data.where('freq').equals(24).and(e => e.time < Math.round(Date.now() / 1000) - 24 * 60 * 60 * 366).delete().then(e => e),
                ])
            },
            swap(to, from) {
                console.log('foo')
                from = from || this.from;
                let d = Math.round(new Date().now / 1000);
                // console.log(to)
                if (this.gameover) return alert('Game over.');
                console.log(from.symbol);
                console.log(!to, !to.symbol, !from.amount, from.amount > this.state[from.symbol], this.state.points_to_start);
                if (!to || !to.symbol || !from.amount || from.amount > (this.state[from.symbol] || this.state.points_to_start)) return alert('Not enough funds.');
                // TODO: look for prices in DB not from API
                // fetch(`https://min-api.cryptocompare.com/data/v2/histominute?fsym=${from.symbol||'USD'}&tsym=${to.symbol}&limit=1`).then(e => e.json()).then(e => (console.log(e.Data)))
                fetch(`https://min-api.cryptocompare.com/data/v2/histominute?fsym=${from.symbol || 'USD'}&tsym=${to.symbol}&limit=1`).then(e => e.json()).then(e => (this.plays.push([{ [from.symbol || 'points_to_start']: -1 * from.amount, [to.symbol]: e.Data.Data[0].close * from.amount }])))
                this.swapping = 0
                // this.to.amount = 0;
                // this.to.symbol = ''
            },
            run_clock() {
                if (this.gameover) {
                    return
                }
                let now = new Date().getTime();
                // console.log(Math.floor(Math.floor((this.end-now)/1000)%60))
                this.time = `${Math.floor(Math.floor((this.end - now) / 1000) / 60)}:${Math.floor(Math.floor((this.end - now) / 1000) % 60)}`;
                if (this.end - now <= 0) this.gameover = 1
            },
            async get_price_from_cryptocompare() {
                if (this.idle) return console.log('idle for too long or window not focused.')
                // if (this.gameover) return
                // if (!this.c_price) return console.log('Price data not in sync.');
                // console.log(this.ticker_symbols)
                if (this.ticker_symbols.length) {

                    let foo = await get_cryptocompare_prices(this.ticker_symbols);//.then(e => );
                    let records = 0;
                    this.ticker_symbols.reduce((a, symbol) => {
                        return a.then(async () => {
                            await get_minutely_from_cryptocompare(symbol).then(async datapoints => {
                                if (!datapoints) return console.log('No datapoints to extract!');
                                let threshold = await cryptxgang_db.data.where('symbol').equals(symbol).and(d => d.freq === 60).last()
                                if (records = datapoints.length) {
                                    // console.log({threshold, datapoint: datapoints.at(-1)})
                                    datapoints = datapoints.filter(e => e.time > threshold.time)
                                    if (!datapoints.length) return;
                                    await cryptxgang_db.data.bulkAdd(datapoints.map(g => ({ ...g, symbol, freq: 60, platform: 'cryptocompare' }))).then(function (lastKey) {
                                        console.log(datapoints.length + ' cryptocompare minutely records added for ' + symbol + '.')
                                        // console.log("Done adding 100,000 raindrops all over the place");
                                        console.log("Last datapoint id was: " + lastKey); // Will be 100000.
                                    }).catch(Dexie.BulkError, function (e) {
                                        // console.log('errors', records - e.failures.length)
                                        // Explicitely catching the bulkAdd() operation makes those successful
                                        // additions commit despite that there were errors.
                                        console.error('Some transactions did not succeed. ' + Number(records - e.failures.length) + ' cryptocompare minutely records added successfully for ' + symbol + '.');
                                    });
                                }
                            });
                            if (this.HOU) {
                                await get_hourly_from_cryptocompare(symbol).then(async datapoints => {
                                    if (records = datapoints.length) {
                                        await cryptxgang_db.data.bulkAdd(datapoints.map(g => ({ ...g, symbol, freq: 360, platform: 'cryptocompare' }))).then(function (lastKey) {
                                            console.log(datapoints.length + ' cryptocompare hourly records added for ' + symbol + '.')
                                            // console.log("Done adding 100,000 raindrops all over the place");
                                            console.log("Last datapoint id was: " + lastKey); // Will be 100000.
                                        }).catch(Dexie.BulkError, function (e) {
                                            // console.log('errors', records - e.failures.length)
                                            // Explicitely catching the bulkAdd() operation makes those successful
                                            // additions commit despite that there were errors.
                                            console.error('Some transactions did not succeed. ' + Number(records - e.failures.length) + ' cryptocompare hourly records added successfully for ' + symbol + '.');
                                        });
                                    }
                                });
                            }
                            if (this.DAY) {
                                await get_daily_from_cryptocompare(symbol).then(async datapoints => {
                                    if (records = datapoints.length) {
                                        await cryptxgang_db.data.bulkAdd(datapoints.map(g => ({ ...g, symbol, freq: 24, platform: 'cryptocompare' }))).then(function (lastKey) {
                                            console.log(datapoints.length + ' cryptocompare daily records added for ' + symbol + '.')
                                            // console.log("Done adding 100,000 raindrops all over the place");
                                            console.log("Last datapoint id was: " + lastKey); // Will be 100000.
                                        }).catch(Dexie.BulkError, function (e) {
                                            // console.log('errors', records - e.failures.length)
                                            // Explicitely catching the bulkAdd() operation makes those successful
                                            // additions commit despite that there were errors.
                                            console.error('Some transactions did not succeed. ' + Number(records - e.failures.length) + ' cryptocompare daily records added successfully for ' + symbol + '.');
                                        });
                                    }
                                });
                            }
                            return Promise.resolve(null);
                        })
                    }, Promise.resolve(null)).then(e=>this.teardown().then(e=>console.log(e)))
                    // this.get_cryptocompare_OHLCV()
                    if (foo.Response === 'Error') return alert(foo.Message);
                    console.log('getting prices from cryptcompare...');
                    this.cryptocompare_prices = Object.entries(foo.RAW);
                }
            }
        },
        async mounted() {
            cryptxgang_db = new Dexie("cryptxgang_db");
            cryptxgang_db.version(1).stores({
                settings: 'name,value',
                data: '[freq+symbol+time+platform],symbol',
                tokens: 'symbol',
            });
            cryptxgang_db.on('changes', function (changes) {
                changes.forEach(function (change) {
                    switch (change.type) {
                        case 1: // CREATED
                            // console.log('An object was created: ' + JSON.stringify(change.obj));
                            // Promise.all(app.ticker_symbols.map(async e => await cryptxgang_db.data.where('symbol').equals(e).toArray())).then(datapoints => app.datapoints = [].concat(...datapoints))
                            break;
                        case 2: // UPDATED
                            if (change.key === "tickers") app.internal_ticker_symbols = change.mods;
                            // console.log('An object with key ' + change.key + ' was updated with modifications: ' + JSON.stringify(change.mods));
                            // Promise.all(app.ticker_symbols.map(async e => await cryptxgang_db.data.where('symbol').equals(e).toArray())).then(datapoints => app.datapoints = [].concat(...datapoints))
                            break;
                        case 3: // DELETED
                            // console.log('An object was deleted: ' + JSON.stringify(change.oldObj));
                            // Promise.all(app.ticker_symbols.map(async e => await cryptxgang_db.data.where('symbol').equals(e).toArray())).then(datapoints => app.datapoints = [].concat(...datapoints))
                            break;
                        default:
                            break;
                    }
                });
                console.time('db update')
                Promise.all(app.ticker_symbols.map(async e => await cryptxgang_db.data.where('symbol').equals(e).toArray())).then(datapoints => app.datapoints = console.timeEnd('db update') || [].concat(...datapoints))
            });
            new Promise(async function (resolve, reject) {
                await cryptxgang_db.settings.get('tickers').then(async e => {
                    if (e && e.value) return resolve(e.value);
                    e = app.default.ticker_symbols;
                    await cryptxgang_db.settings.put({ name: "tickers", value: e }).then(f => resolve(e))
                })
            })
                .then(async function (value) {
                    console.log(value)
                    app.internal_ticker_symbols = value;
                    let h = {};
                    // let foobar = await Promise.all(app.ticker_symbols.map(async e => await cryptxgang_db.data.where('freq').equals(60).and(dp => dp.symbol === e).toArray()))

                    let foobar = await Promise.all(app.ticker_symbols.map(async e => await cryptxgang_db.data.where('symbol').equals(e).toArray()))
                    // Promise.all(app.ticker_symbols.map(async e => await cryptxgang_db.data.where('symbol').equals(e).toArray())).then(e => console.log(e))
                    app.datapoints = [].concat(...foobar);
                    return



                    _heartbeat(app.get_price_from_cryptocompare, 20000);
                    _heartbeat(app.get_minutely_from_cryptocompare, 45000);

                }).catch(function (error) {
                    //
                    // Finally don't forget to catch any error
                    // that could have happened anywhere in the
                    // code blocks above.
                    //
                    alert("Ooops: " + error);
                });
            await new Promise(async function (resolve, reject) {
                // cryptxgang_db.cryptos.toArray().then(e => console.log('bar'))
                await cryptxgang_db.tokens.toArray().then(async e => {
                    // console.log(e.length)
                    if (e.length) return e;
                    // if (e && e.value) return resolve(e.value);
                    // e = this.default.ticker_symbols;
                    // await cryptxgang_db.settings.put({ name: "tickers", value: e }).then(f => resolve(e))
                    let foo = await fetch('https://min-api.cryptocompare.com/data/top/totaltoptiervolfull?limit=100&tsym=USD').then(f => f.json())//.then(e => (console.log(this.cryptos = e.Data))).then(e=>e);
                    //TODO: check list for new cryptos
                    // console.log(foo.Data)
                    // console.log(foo.Data.map(e=>e.RAW&&e.RAW.USD.FROMSYMBOL))
                    // foo.Data.forEach(f => console.log())
                    // Promise.all(foo.Data.map(f => cryptxgang_db.cryptos.put(Object.assign({},f)))).then(f => console.log(foo.Data.length + " cryptos added.")).catch(console.log.bind(console));
                    Promise.all(foo.Data.map(f => cryptxgang_db.tokens.put({ symbol: f.RAW && f.RAW.USD.FROMSYMBOL || '', ...f }))).then(f => console.log(foo.Data.length + " cryptos added.")).catch(console.log.bind(console));
                    // Promise.all(foo.Data.map(f => cryptxgang_db.cryptos.put(JSON.parse(JSON.stringify(f))))).then(f => console.log(foo.Data.length + " cryptos added.")).catch(console.log.bind(console));
                    return foo.Data;
                }).then(e => resolve(e))
            })
                .then(cryptos => this.cryptos = cryptos)
                // .then(cryptos => console.log(this.cryptos))
                .catch(console.log.bind(console))
            // fetch('https://min-api.cryptocompare.com/data/blockchain/list?api_key=583932a385edf4530535beb8494248479013f3b340bd5e52368f84b29e227492').then(e => e.json()).then(e => (console.log(this.cryptos = e.Data)))
            console.log("Game started at: " + new Date(this.start))
            _heartbeat(this.get_price_from_cryptocompare, 30000);
            _heartbeat(this.run_clock, 1000);

            // console.log("Penalty time starts at: " + new Date(this.start + this.EoG * 60 * 1000))



        }
    });

    function get_cryptocompare_daily(symbol) {
        console.log('getting daily data for ' + symbol + ' from cryptocompare...')
        return fetch(`https://min-api.cryptocompare.com/data/v2/histoday?fsym=${symbol}&tsym=USD&limit=365&api_key=583932a385edf4530535beb8494248479013f3b340bd5e52368f84b29e227492`).then(e => e.json()).then(e => e.Data)
    }
    function get_cryptocompare_hourly(symbol) {
        console.log('getting hourly data for ' + symbol + ' from cryptocompare...')
        return fetch(`https://min-api.cryptocompare.com/data/v2/histohour?fsym=${symbol}&tsym=USD&limit=299&api_key=583932a385edf4530535beb8494248479013f3b340bd5e52368f84b29e227492`).then(e => e.json()).then(e => e.Data)
    }
    function get_cryptocompare_minutely(symbol) {
        console.log('getting minutely data for ' + symbol + ' from cryptocompare...')
        return fetch(`https://min-api.cryptocompare.com/data/v2/histominute?fsym=${symbol}&tsym=USD&limit=299&api_key=583932a385edf4530535beb8494248479013f3b340bd5e52368f84b29e227492`).then(e => e.json()).then(e => e.Data)
    }

    const get_minutely_from_cryptocompare = (function () {
        let TimeTo = {}, When = 0;
        return async function (symbol) {
            // console.log({symbol})
            let Now = Math.round(Date.now() / 1000 + Number.EPSILON), Then = (TimeTo[symbol] || (TimeTo[symbol] = 0)) + 60;
            // console.log([Now,When,Then,When < Then , Now >= Then])
            if (When >= Then || Now >= Then) {
                let foo = await cryptxgang_db.data.where('symbol').equals(symbol).and(dp => dp.freq === 60 && Now < dp.time + 60),
                    bar = await foo.keys().length;
                if (!bar) {
                    let baz = await get_cryptocompare_minutely(symbol);
                    console.log({ When: (When = Now), TimeTo: (TimeTo[symbol] = baz.TimeTo) })
                    return Promise.resolve(baz.Data);
                }
            };
            return Promise.resolve([]);
        }
    }())
    const get_hourly_from_cryptocompare = (function () {
        let TimeTo = {}, When = 0;
        return async function (symbol) {
            // console.log({symbol})
            let Now = Math.round(Date.now() / 1000 + Number.EPSILON), Then = (TimeTo[symbol] || (TimeTo[symbol] = 0)) + 360;
            // console.log([Now,When,Then,When < Then , Now >= Then])
            if (When >= Then || Now >= Then) {
                let foo = await cryptxgang_db.data.where('symbol').equals(symbol).and(dp => dp.freq === 360 && Now < dp.time + 360),
                    bar = await foo.keys().length;
                if (!bar) {
                    let baz = await get_cryptocompare_hourly(symbol);
                    console.log({ When: (When = Now), TimeTo: (TimeTo[symbol] = baz.TimeTo) })
                    return Promise.resolve(baz.Data);
                }
            };
            return Promise.resolve([]);
        }
    }())
    const get_daily_from_cryptocompare = (function () {
        let TimeTo = {}, When = 0;
        return async function (symbol) {
            // console.log({symbol})
            let Now = Math.round(Date.now() / 1000 + Number.EPSILON), Then = (TimeTo[symbol] || (TimeTo[symbol] = 0)) + 360 * 24;
            // console.log([Now,When,Then,When < Then , Now >= Then])
            if (When >= Then || Now >= Then) {
                let foo = await cryptxgang_db.data.where('symbol').equals(symbol).and(dp => dp.freq === 24 && Now < dp.time + 360 * 24),
                    bar = await foo.keys().length;
                if (!bar) {
                    let baz = await get_cryptocompare_daily(symbol);
                    console.log({ When: (When = Now), TimeTo: (TimeTo[symbol] = baz.TimeTo) })
                    return Promise.resolve(baz.Data);
                }
            };
            return Promise.resolve([]);
        }
    }())
    // https://stackoverflow.com/questions/667555/how-to-detect-idle-time-in-javascript
    var inactivityTime = function () {
        var time;
        window.onload = resetTimer;
        // DOM Events
        document.onmousemove = resetTimer;
        document.onkeydown = resetTimer;
        window.onfocus = function () { app.idle = 0 };
        window.onblur = function () { app.idle = 1 };

        function logout() {
            app && (app.idle = 1);
            // alert("You are now logged out.")
            //location.href = 'logout.html'
        }

        function resetTimer() {
            // console.log('timer reset')
            clearTimeout(time);
            time = setTimeout(logout, 30000)
            // 1000 milliseconds = 1 second
        }
    };

    window.onload = function () {
        inactivityTime();
        app.idle = 0;
    }

</script>

</html>